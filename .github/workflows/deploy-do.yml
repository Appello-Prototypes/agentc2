# Digital Ocean Deployment Workflow
#
# Tests in CI, builds on the 32GB production server (where .env has all
# credentials), with rollback safety, crash-loop detection, Slack
# notifications, and health checks.
#
# Required secrets:
#   DO_HOST       - Droplet IP address
#   DO_USERNAME   - SSH username (e.g., root)
#   DO_SSH_KEY    - Private SSH key for authentication
#
# Optional secrets:
#   SLACK_WEBHOOK_URL - Incoming Webhook for deploy notifications
#   TURBO_TOKEN       - Vercel Remote Cache token (free tier)
#   TURBO_TEAM        - Vercel team slug for remote cache

name: Deploy to Digital Ocean

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests (requires justification in PR description)"
        required: false
        default: "false"
        type: boolean
      environment:
        description: "Target environment"
        required: false
        default: "production"
        type: choice
        options:
          - production
          - staging

concurrency:
  group: deploy-${{ github.ref_name == 'develop' && 'staging' || 'production' }}
  cancel-in-progress: true

env:
  DEPLOY_PATH: /var/www/agentc2
  # 6GB heap for CI runner (7GB RAM total)
  NODE_OPTIONS: "--max-old-space-size=6144"

jobs:
  # ── Quality gates (runs in GitHub Actions) ─────────────────────────
  test:
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma client
        run: cd packages/database && bun run --bun prisma generate
        env:
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"

      - name: Type check
        run: bunx turbo type-check --concurrency=1
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

      - name: Lint
        run: bunx turbo lint --concurrency=1
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

  # ── Build on server + deploy ───────────────────────────────────────
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    env:
      IS_STAGING: ${{ github.ref_name == 'develop' || github.event.inputs.environment == 'staging' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ (github.ref_name == 'develop' || github.event.inputs.environment == 'staging') && secrets.DO_STAGING_HOST || secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          command_timeout: 35m
          script: |
            set -euo pipefail
            export PATH="$HOME/.bun/bin:$PATH"

            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            COMMIT="${{ github.sha }}"
            SHORT_SHA="${COMMIT:0:7}"
            DEPLOY_STATUS="success"

            # ── Rollback trap ────────────────────────────────────
            rollback() {
              echo ""
              echo "!! DEPLOY FAILED — rolling back..."
              DEPLOY_STATUS="failed"
              cd "$DEPLOY_PATH"
              for app in agent frontend; do
                bak="apps/$app/.next.bak"
                if [ -d "$bak" ] && [ -f "$bak/BUILD_ID" ]; then
                  cache_dir="apps/$app/.next/cache"
                  cache_tmp=""
                  if [ -d "$cache_dir" ]; then
                    cache_tmp=$(mktemp -d)
                    mv "$cache_dir" "$cache_tmp/cache"
                  fi
                  rm -rf "apps/$app/.next"
                  mv "$bak" "apps/$app/.next"
                  if [ -n "$cache_tmp" ] && [ -d "$cache_tmp/cache" ]; then
                    mv "$cache_tmp/cache" "apps/$app/.next/cache"
                    rm -rf "$cache_tmp"
                  fi
                  echo "   Restored apps/$app/.next from backup (cache preserved)"
                else
                  echo "   Skipping $app backup (missing or invalid — no BUILD_ID)"
                fi
              done
              echo "   Restarting PM2 with previous build..."
              pm2 restart ecosystem.config.js --update-env || true
              echo "!! Rollback complete. Previous version is running."
            }
            trap rollback ERR

            echo "=========================================="
            echo "Deploying AgentC2 AI Agent Framework"
            echo "Commit: $SHORT_SHA"
            echo "=========================================="

            cd "$DEPLOY_PATH"

            echo ""
            echo "1. Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            echo ""
            echo "2. Installing dependencies..."
            bun install

            echo ""
            echo "3. Generating Prisma client..."
            bun run db:generate

            echo ""
            echo "4. Running database migrations..."
            bun run db:push || echo "Note: No schema changes"

            echo ""
            echo "5. Backing up current build (rollback safety)..."
            rm -rf apps/agent/.next.bak apps/frontend/.next.bak
            for app in agent frontend; do
              if [ -d "apps/$app/.next" ]; then
                mkdir -p "apps/$app/.next.bak"
                rsync -a --exclude='cache' "apps/$app/.next/" "apps/$app/.next.bak/"
              fi
            done
            echo "   Backups created (excluding cache)."

            echo ""
            echo "6. Validating build caches and cleaning locks..."
            for app in agent frontend admin; do if [ -d "apps/$app/.next/cache/webpack" ]; then echo "   $app: cache present — preserving"; else echo "   $app: no cache"; fi; rm -f "apps/$app/.next/lock" 2>/dev/null || true; done
            echo "   Done."

            echo ""
            echo "7a. Building sandbox Docker image (if changed)..."
            DOCKERFILE="packages/agentc2/docker/Dockerfile.sandbox"
            if ! command -v docker >/dev/null 2>&1; then
              echo "   Docker not installed — skipping sandbox image build."
            elif [ -f "$DOCKERFILE" ]; then
              CURRENT_HASH=$(sha256sum "$DOCKERFILE" | cut -d' ' -f1)
              STORED_HASH=""
              if [ -f "/var/lib/agentc2/.sandbox-image-hash" ]; then
                STORED_HASH=$(cat /var/lib/agentc2/.sandbox-image-hash)
              fi
              if [ "$CURRENT_HASH" != "$STORED_HASH" ] || ! docker image inspect agentc2-sandbox >/dev/null 2>&1; then
                echo "   Dockerfile changed or image missing — rebuilding..."
                docker build -t agentc2-sandbox -f "$DOCKERFILE" . 2>&1 | tail -5
                mkdir -p /var/lib/agentc2
                echo "$CURRENT_HASH" > /var/lib/agentc2/.sandbox-image-hash
                echo "   Sandbox image built."
              else
                echo "   Sandbox image unchanged — skipping build."
              fi
            else
              echo "   No Dockerfile.sandbox found — skipping."
            fi

            echo ""
            echo "7b. Building applications (on-server, full .env, 24GB heap, remote cache)..."
            export TURBO_TOKEN="${{ secrets.TURBO_TOKEN }}"
            export TURBO_TEAM="${{ secrets.TURBO_TEAM }}"
            NODE_OPTIONS="--max-old-space-size=24576" bunx turbo build

            echo ""
            echo "8. Updating Caddy configuration..."
            sudo cp apps/caddy/Caddyfile.production /etc/caddy/Caddyfile
            sudo systemctl reload caddy || sudo systemctl restart caddy

            echo ""
            echo "9. Reloading PM2 processes (zero-downtime)..."
            pm2 reload ecosystem.config.js --update-env || pm2 start ecosystem.config.js
            pm2 save

            echo ""
            echo "10. Crash-loop detection (waiting 15s)..."
            sleep 15

            # Check that expected processes are online (simple grep, no multiline python)
            AGENT_STATUS=$(pm2 show agent 2>/dev/null | grep -oP 'status\s+│\s+\K\S+' || echo "missing")
            FRONTEND_STATUS=$(pm2 show frontend 2>/dev/null | grep -oP 'status\s+│\s+\K\S+' || echo "missing")
            echo "   Agent:    $AGENT_STATUS"
            echo "   Frontend: $FRONTEND_STATUS"
            if [ "$AGENT_STATUS" != "online" ] || [ "$FRONTEND_STATUS" != "online" ]; then echo "!! Process not online — triggering rollback"; exit 1; fi

            echo ""
            echo "11. Cleaning up backups..."
            rm -rf apps/agent/.next.bak apps/frontend/.next.bak

            pm2 status

            echo ""
            echo "=========================================="
            echo "Deployment complete! ($SHORT_SHA)"
            echo "=========================================="

      - name: Health check
        run: |
          echo "Running health checks..."
          sleep 5
          HTTP_HOME=$(curl -sf -o /dev/null -w "%{http_code}" https://agentc2.ai/ || echo "000")
          HTTP_LOGIN=$(curl -sf -o /dev/null -w "%{http_code}" https://agentc2.ai/login || echo "000")
          echo "Homepage: HTTP $HTTP_HOME"
          echo "Login:    HTTP $HTTP_LOGIN"
          if [ "$HTTP_HOME" = "000" ] || [ "$HTTP_LOGIN" = "000" ]; then
            echo "::warning::Health check could not reach production URLs"
          fi

      - name: Notify Slack (success)
        if: success()
        run: |
          WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          if [ -z "$WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured — skipping notification"
            exit 0
          fi
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1 | sed 's/"/\\"/g')
          curl -sf -X POST "$WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d "{
              \"text\": \":white_check_mark: *Deploy succeeded* — \`${{ github.sha }}\`\n>${COMMIT_MSG}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>\"
            }" || echo "Slack notification failed (non-fatal)"

      - name: Notify Slack (failure)
        if: failure()
        run: |
          WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          if [ -z "$WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured — skipping notification"
            exit 0
          fi
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1 | sed 's/"/\\"/g')
          curl -sf -X POST "$WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d "{
              \"text\": \":x: *Deploy FAILED* — \`${{ github.sha }}\`\n>${COMMIT_MSG}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>\"
            }" || echo "Slack notification failed (non-fatal)"
