# Digital Ocean Deployment Workflow
#
# Automatically deploys to Digital Ocean Droplet on push to main
#
# Required secrets:
# - DO_HOST: Droplet IP address
# - DO_USERNAME: SSH username (e.g., deploy)
# - DO_SSH_KEY: Private SSH key for authentication

name: Deploy to Digital Ocean

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests before deployment"
        required: false
        default: "false"
        type: boolean

env:
  NODE_ENV: production
  DEPLOY_PATH: /var/www/mastra

jobs:
  # Run tests before deployment
  test:
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma client
        run: bun run db:generate
        env:
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"

      - name: Type check
        run: bun run type-check

      - name: Lint
        run: bun run lint

      - name: Run unit tests
        run: bun run test:unit || echo "No unit tests configured"

  # Build verification (optional - can be removed if slow)
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma client
        run: bun run db:generate
        env:
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"

      - name: Build applications
        run: bun run build
        env:
          # Minimal env vars for build
          NEXT_PUBLIC_APP_URL: "https://placeholder.com"
          BETTER_AUTH_SECRET: "placeholder-secret-for-build"

  # Deploy to Digital Ocean
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    if: always() && needs.build.result == 'success'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            echo "=========================================="
            echo "Deploying Mastra AI Agent Framework"
            echo "Commit: ${{ github.sha }}"
            echo "=========================================="

            cd ${{ env.DEPLOY_PATH }}

            echo ""
            echo "1. Pulling latest code..."
            git fetch origin
            git checkout main
            git pull origin main

            echo ""
            echo "2. Installing dependencies..."
            bun install

            echo ""
            echo "3. Generating Prisma client..."
            bun run db:generate

            echo ""
            echo "4. Running database migrations..."
            bun run db:push || echo "Note: No schema changes"

            echo ""
            echo "5. Building applications..."
            NODE_ENV=production bun run build

            echo ""
            echo "6. Restarting PM2 processes..."
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js

            echo ""
            echo "7. Saving PM2 process list..."
            pm2 save

            echo ""
            echo "8. Application status:"
            pm2 status

            echo ""
            echo "=========================================="
            echo "Deployment complete!"
            echo "=========================================="

      - name: Health check
        run: |
          echo "Waiting for application to start..."
          sleep 10

          # Health check (replace with your actual domain)
          # curl -f https://your-domain.com/api/health || echo "Health check skipped - configure domain"

          echo "Deployment successful!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment failed! Check the logs above for details."
