# Digital Ocean Deployment Workflow
#
# Tests in CI, builds on the 32GB production server (where .env has all
# credentials), with rollback safety, crash-loop detection, Slack
# notifications, and health checks.
#
# Required secrets:
#   DO_HOST       - Droplet IP address
#   DO_USERNAME   - SSH username (e.g., root)
#   DO_SSH_KEY    - Private SSH key for authentication
#
# Optional secrets:
#   SLACK_WEBHOOK_URL - Incoming Webhook for deploy notifications
#   TURBO_TOKEN       - Vercel Remote Cache token (free tier)
#   TURBO_TEAM        - Vercel team slug for remote cache

name: Deploy to Digital Ocean

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests before deployment"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  DEPLOY_PATH: /var/www/mastra
  # 6GB heap for CI runner (7GB RAM total)
  NODE_OPTIONS: "--max-old-space-size=6144"

jobs:
  # ── Quality gates (runs in GitHub Actions) ─────────────────────────
  test:
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma client
        run: bun run db:generate
        env:
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"

      - name: Type check
        run: bunx turbo type-check --concurrency=1
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

      - name: Lint
        run: bunx turbo lint --concurrency=1
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

  # ── Build on server + deploy ───────────────────────────────────────
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          command_timeout: 25m
          script: |
            set -euo pipefail
            export PATH="$HOME/.bun/bin:$PATH"

            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            COMMIT="${{ github.sha }}"
            SHORT_SHA="${COMMIT:0:7}"
            DEPLOY_STATUS="success"

            # ── Rollback trap ────────────────────────────────────
            rollback() {
              echo ""
              echo "!! DEPLOY FAILED — rolling back..."
              DEPLOY_STATUS="failed"
              cd "$DEPLOY_PATH"
              if [ -d apps/agent/.next.bak ]; then
                rm -rf apps/agent/.next
                mv apps/agent/.next.bak apps/agent/.next
                echo "   Restored apps/agent/.next from backup"
              fi
              if [ -d apps/frontend/.next.bak ]; then
                rm -rf apps/frontend/.next
                mv apps/frontend/.next.bak apps/frontend/.next
                echo "   Restored apps/frontend/.next from backup"
              fi
              echo "   Restarting PM2 with previous build..."
              pm2 restart ecosystem.config.js --update-env || true
              echo "!! Rollback complete. Previous version is running."
            }
            trap rollback ERR

            echo "=========================================="
            echo "Deploying Mastra AI Agent Framework"
            echo "Commit: $SHORT_SHA"
            echo "=========================================="

            cd "$DEPLOY_PATH"

            echo ""
            echo "1. Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            echo ""
            echo "2. Installing dependencies..."
            bun install

            echo ""
            echo "3. Generating Prisma client..."
            bun run db:generate

            echo ""
            echo "4. Running database migrations..."
            bun run db:push || echo "Note: No schema changes"

            echo ""
            echo "5. Backing up current build (rollback safety)..."
            rm -rf apps/agent/.next.bak apps/frontend/.next.bak
            [ -d apps/agent/.next ] && cp -r apps/agent/.next apps/agent/.next.bak
            [ -d apps/frontend/.next ] && cp -r apps/frontend/.next apps/frontend/.next.bak
            echo "   Backups created."

            echo ""
            echo "6. Building applications (on-server, full .env, 24GB heap, remote cache)..."
            rm -f apps/agent/.next/lock apps/frontend/.next/lock 2>/dev/null || true
            export TURBO_TOKEN="${{ secrets.TURBO_TOKEN }}"
            export TURBO_TEAM="${{ secrets.TURBO_TEAM }}"
            NODE_OPTIONS="--max-old-space-size=24576" bunx turbo build

            echo ""
            echo "7. Updating Caddy configuration..."
            sudo cp apps/caddy/Caddyfile.production /etc/caddy/Caddyfile
            sudo systemctl reload caddy || sudo systemctl restart caddy

            echo ""
            echo "8. Restarting PM2 processes..."
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
            pm2 save

            echo ""
            echo "9. Crash-loop detection (waiting 15s)..."
            sleep 15

            # Check that expected processes are online (simple grep, no multiline python)
            AGENT_STATUS=$(pm2 show agent 2>/dev/null | grep -oP 'status\s+│\s+\K\S+' || echo "missing")
            FRONTEND_STATUS=$(pm2 show frontend 2>/dev/null | grep -oP 'status\s+│\s+\K\S+' || echo "missing")
            echo "   Agent:    $AGENT_STATUS"
            echo "   Frontend: $FRONTEND_STATUS"
            if [ "$AGENT_STATUS" != "online" ] || [ "$FRONTEND_STATUS" != "online" ]; then echo "!! Process not online — triggering rollback"; exit 1; fi

            echo ""
            echo "10. Cleaning up backups..."
            rm -rf apps/agent/.next.bak apps/frontend/.next.bak

            pm2 status

            echo ""
            echo "=========================================="
            echo "Deployment complete! ($SHORT_SHA)"
            echo "=========================================="

      - name: Health check
        run: |
          echo "Running health checks..."
          sleep 5
          HTTP_HOME=$(curl -sf -o /dev/null -w "%{http_code}" https://agentc2.ai/ || echo "000")
          HTTP_LOGIN=$(curl -sf -o /dev/null -w "%{http_code}" https://agentc2.ai/login || echo "000")
          echo "Homepage: HTTP $HTTP_HOME"
          echo "Login:    HTTP $HTTP_LOGIN"
          if [ "$HTTP_HOME" = "000" ] || [ "$HTTP_LOGIN" = "000" ]; then
            echo "::warning::Health check could not reach production URLs"
          fi

      - name: Notify Slack (success)
        if: success()
        run: |
          WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          if [ -z "$WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured — skipping notification"
            exit 0
          fi
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1 | sed 's/"/\\"/g')
          curl -sf -X POST "$WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d "{
              \"text\": \":white_check_mark: *Deploy succeeded* — \`${{ github.sha }}\`\n>${COMMIT_MSG}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>\"
            }" || echo "Slack notification failed (non-fatal)"

      - name: Notify Slack (failure)
        if: failure()
        run: |
          WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          if [ -z "$WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured — skipping notification"
            exit 0
          fi
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1 | sed 's/"/\\"/g')
          curl -sf -X POST "$WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d "{
              \"text\": \":x: *Deploy FAILED* — \`${{ github.sha }}\`\n>${COMMIT_MSG}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>\"
            }" || echo "Slack notification failed (non-fatal)"
