# AgentC2 Sandbox — Docker-isolated execution environment for AI agents
#
# Provides: bash, Python 3, Node 20, Bun, doctl, supabase CLI, ssh, git
# Security: runs as non-root user, no secrets baked into image

FROM debian:bookworm-slim AS base

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    bash \
    curl \
    wget \
    jq \
    git \
    openssh-client \
    ca-certificates \
    gnupg \
    python3 \
    python3-pip \
    python3-venv \
    unzip \
    rsync \
    && rm -rf /var/lib/apt/lists/*

# ── Node.js 20 (via NodeSource) ──────────────────────────────────────
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && rm -rf /var/lib/apt/lists/*

# ── Bun ──────────────────────────────────────────────────────────────
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

# ── DigitalOcean CLI (doctl) ─────────────────────────────────────────
RUN DOCTL_VERSION=$(curl -s https://api.github.com/repos/digitalocean/doctl/releases/latest | jq -r '.tag_name' | sed 's/^v//') \
    && curl -sL "https://github.com/digitalocean/doctl/releases/download/v${DOCTL_VERSION}/doctl-${DOCTL_VERSION}-linux-amd64.tar.gz" | tar xz -C /usr/local/bin

# ── Supabase CLI ─────────────────────────────────────────────────────
RUN SUPABASE_VERSION=$(curl -s https://api.github.com/repos/supabase/cli/releases/latest | jq -r '.tag_name' | sed 's/^v//') \
    && curl -sL "https://github.com/supabase/cli/releases/download/v${SUPABASE_VERSION}/supabase_${SUPABASE_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin supabase

# ── Non-root user ────────────────────────────────────────────────────
RUN groupadd -g 1000 sandbox \
    && useradd -m -u 1000 -g sandbox sandbox \
    && mkdir -p /workspace \
    && chown sandbox:sandbox /workspace

# Move bun to sandbox user
RUN cp -r /root/.bun /home/sandbox/.bun \
    && chown -R sandbox:sandbox /home/sandbox/.bun

ENV PATH="/home/sandbox/.bun/bin:/usr/local/bin:/usr/bin:/bin"

USER sandbox
WORKDIR /workspace

# Verify installations
RUN bash --version | head -1 \
    && node --version \
    && bun --version \
    && python3 --version \
    && git --version \
    && doctl version \
    && supabase --version \
    && ssh -V 2>&1 | head -1 \
    && echo "All tools verified."

ENTRYPOINT ["/bin/bash", "-c"]
