// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Better Auth Models
model User {
    id                     String                  @id @default(cuid())
    name                   String
    email                  String                  @unique
    emailVerified          Boolean                 @default(false)
    image                  String?
    createdAt              DateTime                @default(now())
    updatedAt              DateTime                @updatedAt
    sessions               Session[]
    accounts               Account[]
    agents                 Agent[]
    integrationConnections IntegrationConnection[]

    @@map("user")
}

model Session {
    id        String   @id @default(cuid())
    expiresAt DateTime
    token     String   @unique
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    ipAddress String?
    userAgent String?
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@map("session")
}

model Account {
    id                    String    @id @default(cuid())
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    @@index([userId])
    @@map("account")
}

model Verification {
    id         String    @id @default(cuid())
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime? @default(now())
    updatedAt  DateTime? @updatedAt

    @@map("verification")
}

// ==============================
// Multi-Tenant Organization Models
// ==============================

// Organization - Company or team boundary for multi-tenancy
model Organization {
    id          String   @id @default(cuid())
    name        String
    slug        String   @unique // URL-safe identifier
    description String?
    logoUrl     String?
    metadata    Json?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // Relations
    workspaces             Workspace[]
    memberships            Membership[]
    credentials            ToolCredential[]
    integrationConnections IntegrationConnection[]
    identityMappings       IdentityMapping[]
    approvalRequests       ApprovalRequest[]
    crmAuditLogs           CrmAuditLog[]
    emailThreads           EmailThread[]
    chatMessages           ChatMessage[]
    meetingTranscripts     MeetingTranscript[]
    actionItems            ActionItem[]
    invites                OrganizationInvite[]
    domains                OrganizationDomain[]

    @@index([slug])
    @@map("organization")
}

// Workspace - Environment within an org (dev/staging/prod)
model Workspace {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    name           String
    slug           String // URL-safe identifier within org
    environment    String       @default("development") // "development", "staging", "production"
    description    String?
    isDefault      Boolean      @default(false)
    metadata       Json?
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt

    // Relations
    agents            Agent[]
    schedules         AgentSchedule[]
    triggers          AgentTrigger[]
    workflows         Workflow[]
    networks          Network[]
    bimModels         BimModel[]
    GmailIntegration  GmailIntegration[]
    TriggerEvent      TriggerEvent[]
    EmailThread       EmailThread[]
    ChatMessage       ChatMessage[]
    MeetingTranscript MeetingTranscript[]
    ActionItem        ActionItem[]
    ApprovalRequest   ApprovalRequest[]
    CrmAuditLog       CrmAuditLog[]
    documents         Document[]
    skills            Skill[]
    canvases          Canvas[]

    @@unique([organizationId, slug])
    @@index([organizationId])
    @@map("workspace")
}

// Membership - User's role in an organization
model Membership {
    id                    String       @id @default(cuid())
    userId                String
    organizationId        String
    organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    role                  String       @default("member") // "owner", "admin", "member", "viewer"
    onboardingCompletedAt DateTime?
    onboardingStep        String?
    createdAt             DateTime     @default(now())
    updatedAt             DateTime     @updatedAt

    @@unique([userId, organizationId])
    @@index([userId])
    @@index([organizationId])
    @@map("membership")
}

// Organization Invite - Code-based org join
model OrganizationInvite {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    code           String       @unique
    expiresAt      DateTime?
    maxUses        Int?
    usedCount      Int          @default(0)
    isActive       Boolean      @default(true)
    createdBy      String?
    metadata       Json?
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt

    @@index([organizationId])
    @@map("organization_invite")
}

// Organization Domain - Email domain mapping to org
model OrganizationDomain {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    domain         String       @unique
    isPrimary      Boolean      @default(false)
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt

    @@index([organizationId])
    @@map("organization_domain")
}

// ToolCredential - Scoped credentials for MCP/tool access per organization
model ToolCredential {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    toolId         String // MCP server or tool key (e.g., "hubspot", "jira")
    name           String
    credentials    Json // Encrypted credentials
    isActive       Boolean      @default(true)
    lastUsedAt     DateTime?
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt
    createdBy      String?

    @@unique([organizationId, toolId])
    @@index([organizationId])
    @@map("tool_credential")
}

// Integration Provider - Catalog of available integrations (built-in + custom)
model IntegrationProvider {
    id           String   @id @default(cuid())
    key          String   @unique // Provider key (e.g., "hubspot", "gmail")
    name         String
    description  String?
    category     String // "crm", "communication", "web", "knowledge", "automation", "productivity"
    authType     String // "apiKey", "oauth", "none", "webhook", "custom"
    providerType String // "mcp", "oauth", "webhook", "custom"
    isActive     Boolean  @default(true)
    configJson   Json? // Custom server config, required fields, etc.
    actionsJson  Json? // Cached action metadata
    triggersJson Json? // Cached trigger metadata
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    // Relations
    connections IntegrationConnection[]

    @@map("integration_provider")
}

// Integration Connection - Organization/User scoped connection instances
model IntegrationConnection {
    id             String              @id @default(cuid())
    providerId     String
    provider       IntegrationProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
    organizationId String
    organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    userId         String?
    user           User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
    scope          String              @default("org") // "org" or "user"
    name           String
    isDefault      Boolean             @default(false)
    isActive       Boolean             @default(true)
    credentials    Json?
    metadata       Json?
    lastUsedAt     DateTime?
    lastTestedAt   DateTime?
    errorMessage   String?             @db.Text
    webhookPath    String?
    webhookSecret  String?
    agentTriggerId String?
    agentTrigger   AgentTrigger?       @relation(fields: [agentTriggerId], references: [id], onDelete: SetNull)
    createdAt      DateTime            @default(now())
    updatedAt      DateTime            @updatedAt

    // Relations
    gmailIntegrations       GmailIntegration[]
    emailThreads            EmailThread[]
    chatMessages            ChatMessage[]
    meetingTranscripts      MeetingTranscript[]
    crmAuditLogs            CrmAuditLog[]
    EmailMessage            EmailMessage[]
    webhookSubscriptions    WebhookSubscription[]
    calendarEvents          CalendarEvent[]
    slackChannelPreferences SlackChannelPreference[]

    @@index([organizationId])
    @@index([providerId])
    @@index([userId])
    @@index([agentTriggerId])
    @@map("integration_connection")
}

// Email Thread - Normalized email threads for Gmail/Outlook
model EmailThread {
    id                      String                 @id @default(cuid())
    organizationId          String
    organization            Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    workspaceId             String?
    workspace               Workspace?             @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    integrationConnectionId String?
    integrationConnection   IntegrationConnection? @relation(fields: [integrationConnectionId], references: [id], onDelete: SetNull)
    threadId                String
    subject                 String?
    participantsJson        Json?
    lastMessageAt           DateTime?
    lastInboundAt           DateTime?
    lastOutboundAt          DateTime?
    status                  String?
    summary                 String?                @db.Text
    createdAt               DateTime               @default(now())
    updatedAt               DateTime               @updatedAt

    // Relations
    messages EmailMessage[]

    @@unique([integrationConnectionId, threadId])
    @@index([organizationId])
    @@index([workspaceId])
    @@map("email_thread")
}

// Email Message - Normalized email messages
model EmailMessage {
    id                      String                 @id @default(cuid())
    threadId                String
    thread                  EmailThread            @relation(fields: [threadId], references: [id], onDelete: Cascade)
    integrationConnectionId String?
    integrationConnection   IntegrationConnection? @relation(fields: [integrationConnectionId], references: [id], onDelete: SetNull)
    messageId               String
    direction               String? // "inbound" | "outbound"
    fromAddress             String?
    toAddressesJson         Json?
    ccAddressesJson         Json?
    bccAddressesJson        Json?
    subject                 String?
    snippet                 String?
    bodyText                String?                @db.Text
    bodyHtml                String?                @db.Text
    receivedAt              DateTime?
    labelsJson              Json?
    hasAttachments          Boolean                @default(false)
    attachmentsJson         Json?
    metadata                Json?
    createdAt               DateTime               @default(now())
    updatedAt               DateTime               @updatedAt

    @@unique([integrationConnectionId, messageId])
    @@index([threadId])
    @@map("email_message")
}

// Chat Message - Normalized chat events (Slack, Teams, etc.)
model ChatMessage {
    id                      String                 @id @default(cuid())
    organizationId          String
    organization            Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    workspaceId             String?
    workspace               Workspace?             @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    integrationConnectionId String?
    integrationConnection   IntegrationConnection? @relation(fields: [integrationConnectionId], references: [id], onDelete: SetNull)
    channelId               String
    messageTs               String
    userId                  String?
    text                    String?                @db.Text
    isEdited                Boolean                @default(false)
    isDeleted               Boolean                @default(false)
    reactionsJson           Json?
    attachmentsJson         Json?
    metadata                Json?
    createdAt               DateTime               @default(now())
    updatedAt               DateTime               @updatedAt

    @@unique([integrationConnectionId, messageTs])
    @@index([organizationId])
    @@index([workspaceId])
    @@map("chat_message")
}

// Meeting Transcript - Normalized meeting transcripts (Fathom, Zoom, etc.)
model MeetingTranscript {
    id                      String                 @id @default(cuid())
    organizationId          String
    organization            Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    workspaceId             String?
    workspace               Workspace?             @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    integrationConnectionId String?
    integrationConnection   IntegrationConnection? @relation(fields: [integrationConnectionId], references: [id], onDelete: SetNull)
    meetingId               String
    title                   String?
    startedAt               DateTime?
    endedAt                 DateTime?
    participantsJson        Json?
    transcriptText          String?                @db.Text
    summaryText             String?                @db.Text
    actionItemsJson         Json?
    sentimentJson           Json?
    metadata                Json?
    createdAt               DateTime               @default(now())
    updatedAt               DateTime               @updatedAt

    @@unique([integrationConnectionId, meetingId])
    @@index([organizationId])
    @@index([workspaceId])
    @@map("meeting_transcript")
}

// Action Item - Extracted tasks from emails/meetings/chats
model ActionItem {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    workspaceId    String?
    workspace      Workspace?   @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    sourceType     String // "email" | "meeting" | "chat" | "crm"
    sourceId       String?
    title          String
    description    String?      @db.Text
    status         String       @default("open")
    dueAt          DateTime?
    assignee       String?
    metadata       Json?
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt

    @@index([organizationId])
    @@index([workspaceId])
    @@index([status])
    @@map("action_item")
}

// Approval Request - Approval-first workflow tracking
model ApprovalRequest {
    id             String        @id @default(cuid())
    organizationId String
    organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    workspaceId    String?
    workspace      Workspace?    @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    agentId        String?
    agent          Agent?        @relation(fields: [agentId], references: [id], onDelete: SetNull)
    triggerEventId String?
    triggerEvent   TriggerEvent? @relation(fields: [triggerEventId], references: [id], onDelete: SetNull)
    workflowRunId  String?
    workflowRun    WorkflowRun?  @relation(fields: [workflowRunId], references: [id], onDelete: SetNull)
    sourceType     String
    sourceId       String?
    status         String        @default("pending") // "pending" | "approved" | "rejected"
    requestedBy    String?
    requestedAt    DateTime      @default(now())
    decidedBy      String?
    decidedAt      DateTime?
    decisionReason String?       @db.Text
    payloadJson    Json?
    slackChannelId String?
    slackMessageTs String?
    metadata       Json?
    createdAt      DateTime      @default(now())
    updatedAt      DateTime      @updatedAt

    @@index([organizationId])
    @@index([workspaceId])
    @@index([agentId])
    @@index([status])
    @@map("approval_request")
}

// Identity Mapping - Cross-system identity resolution
model IdentityMapping {
    id               String       @id @default(cuid())
    organizationId   String
    organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    email            String?
    domain           String?
    slackUserId      String?
    hubspotContactId String?
    hubspotCompanyId String?
    metadata         Json?
    createdAt        DateTime     @default(now())
    updatedAt        DateTime     @updatedAt

    @@unique([organizationId, email])
    @@index([organizationId])
    @@map("identity_mapping")
}

// CRM Audit Log - Track CRM mutations and notes
model CrmAuditLog {
    id                      String                 @id @default(cuid())
    organizationId          String
    organization            Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    workspaceId             String?
    workspace               Workspace?             @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    integrationConnectionId String?
    integrationConnection   IntegrationConnection? @relation(fields: [integrationConnectionId], references: [id], onDelete: SetNull)
    eventType               String
    recordType              String?
    recordId                String?
    sourceType              String?
    sourceId                String?
    payloadJson             Json?
    actorUserId             String?
    createdAt               DateTime               @default(now())

    @@index([organizationId])
    @@index([recordType, recordId])
    @@map("crm_audit_log")
}

// Agent Type Enum
enum AgentType {
    SYSTEM // Seeded from code, protected from deletion (core platform agents)
    USER // User-created, fully editable
    DEMO // Example/demo agents, discoverable but not production
}

// Run Status Enum
enum RunStatus {
    QUEUED
    RUNNING
    COMPLETED
    FAILED
    CANCELLED
}

// Run Type Enum
enum RunType {
    TEST
    PROD
    AB
}

// Run Environment Enum
enum RunEnvironment {
    DEVELOPMENT
    STAGING
    PRODUCTION
}

// Run Trigger Enum
enum RunTriggerType {
    MANUAL
    API
    SCHEDULED
    WEBHOOK
    TOOL
    TEST
    RETRY
}

enum TriggerEventStatus {
    RECEIVED
    FILTERED
    QUEUED
    SKIPPED
    REJECTED
    NO_MATCH
    ERROR
}

// Workflow Type Enum
enum WorkflowType {
    SYSTEM // Code-defined, protected
    USER // User-created
}

// Network Type Enum
enum NetworkType {
    SYSTEM
    USER
}

// Deployment Status Enum
enum DeploymentStatus {
    DRAFT
    TESTING
    PENDING_REVIEW
    APPROVED
    DEPLOYED
    DEPRECATED
    ARCHIVED
}

// Alert Severity Enum
enum AlertSeverity {
    INFO
    WARNING
    CRITICAL
}

// Alert Source Enum
enum AlertSource {
    COST
    GUARDRAIL
    EVAL
    SYSTEM
}

// Guardrail Event Type Enum
enum GuardrailEventType {
    BLOCKED
    MODIFIED
    FLAGGED
}

// Agents - Database-backed agent configurations (Mastra-aligned)
model Agent {
    id          String  @id @default(cuid())
    slug        String  @unique // URL-safe identifier
    name        String
    description String?

    // Instructions - static or templated
    instructions         String  @db.Text
    instructionsTemplate String? @db.Text // Template with {{userId}}, {{userName}}, etc.

    // Model configuration
    modelProvider String // "openai", "anthropic", "google"
    modelName     String // "gpt-4o", "claude-sonnet-4-20250514"
    temperature   Float? @default(0.7)
    maxTokens     Int?
    modelConfig   Json? // Provider-specific: {reasoning: {type: "enabled"}, toolChoice: "auto"}

    // Tool configuration (junction table)
    tools AgentTool[]

    // Network orchestration
    subAgents String[] @default([]) // Agent slugs this agent can delegate to
    workflows String[] @default([]) // Workflow IDs

    // Memory configuration (Mastra Memory pattern)
    memoryEnabled Boolean @default(false)
    memoryConfig  Json? // {lastMessages, semanticRecall, workingMemory}

    // Multi-step workflows
    maxSteps Int? @default(5)

    // Evaluation configuration
    scorers String[] @default([])

    // Permissions/tenancy
    type        AgentType  @default(USER)
    tenantId    String? // Multi-tenant isolation (legacy, use workspaceId)
    workspaceId String?
    workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    ownerId     String?
    owner       User?      @relation(fields: [ownerId], references: [id])
    isPublic    Boolean    @default(false)

    // Policies
    requiresApproval Boolean @default(false) // Require human approval for runs
    maxSpendUsd      Float? // Max spend per run in USD

    // Metadata
    metadata Json?
    isActive Boolean @default(true)
    version  Int     @default(1)

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    createdBy String?

    // Relations
    versions               AgentVersion[]
    runs                   AgentRun[]
    traces                 AgentTrace[]
    alerts                 AgentAlert[]
    evaluations            AgentEvaluation[]
    feedback               AgentFeedback[]
    testCases              AgentTestCase[]
    testRuns               AgentTestRun[]
    conversations          AgentConversation[]
    budgetPolicy           BudgetPolicy?
    costEvents             CostEvent[]
    costDaily              AgentCostDaily[]
    modelCostDaily         AgentModelCostDaily[]
    costRecommendations    CostRecommendation[]
    guardrailPolicy        GuardrailPolicy?
    guardrailEvents        GuardrailEvent[]
    statsDaily             AgentStatsDaily[]
    metricDaily            AgentMetricDaily[]
    toolMetricDaily        AgentToolMetricDaily[]
    modelMetricDaily       AgentModelMetricDaily[]
    qualityMetricDaily     AgentQualityMetricDaily[]
    feedbackAggregateDaily AgentFeedbackAggregateDaily[]
    versionStats           AgentVersionStats[]
    themes                 EvaluationTheme[]
    insights               Insight[]
    learningSessions       LearningSession[]
    learningMetricDaily    LearningMetricDaily[]
    learningPolicy         LearningPolicy?
    simulationSessions     SimulationSession[]
    schedules              AgentSchedule[]
    triggers               AgentTrigger[]
    networkPrimitives      NetworkPrimitive[]
    GmailIntegration       GmailIntegration[]
    TriggerEvent           TriggerEvent[]
    ApprovalRequest        ApprovalRequest[]
    skills                 AgentSkill[]

    @@index([slug])
    @@index([workspaceId])
    @@index([ownerId])
    @@index([tenantId])
    @@index([type])
    @@map("agent")
}

// Agent-Tool Junction Table
model AgentTool {
    id      String @id @default(cuid())
    agentId String
    agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
    toolId  String // Tool registry key (e.g., "calculator", "web-fetch")
    config  Json? // Tool-specific: {inputSchema, outputSchema, description override}

    @@unique([agentId, toolId])
    @@map("agent_tool")
}

// Agent Version History
model AgentVersion {
    id            String   @id @default(cuid())
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    version       Int
    description   String?  @db.Text
    instructions  String   @db.Text
    modelProvider String
    modelName     String
    changesJson   Json? // Description of changes from previous version
    snapshot      Json // Full agent config + tool IDs + scorer IDs at this version
    createdAt     DateTime @default(now())
    createdBy     String?

    // Relations
    versionStats AgentVersionStats[]

    @@unique([agentId, version])
    @@index([agentId, version])
    @@map("agent_version")
}

// Agent Schedule - Cron-based recurring execution
model AgentSchedule {
    id          String     @id @default(cuid())
    agentId     String
    agent       Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)
    workspaceId String?
    workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    name        String
    description String?
    cronExpr    String // Cron expression (e.g., "0 17 * * FRI")
    timezone    String     @default("UTC")
    inputJson   Json? // Default input for scheduled runs
    isActive    Boolean    @default(true)
    lastRunAt   DateTime?
    nextRunAt   DateTime?
    runCount    Int        @default(0)
    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @updatedAt
    createdBy   String?

    @@index([agentId])
    @@index([workspaceId])
    @@index([isActive, nextRunAt])
    @@map("agent_schedule")
}

// Agent Trigger - Event-based invocation
model AgentTrigger {
    id                    String                  @id @default(cuid())
    agentId               String
    agent                 Agent                   @relation(fields: [agentId], references: [id], onDelete: Cascade)
    workspaceId           String?
    workspace             Workspace?              @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    name                  String
    description           String?
    triggerType           String // "webhook", "event", "mcp"
    eventName             String? // Event name to listen for
    webhookPath           String? // Unique webhook path for this trigger
    webhookSecret         String? // Secret for webhook validation
    filterJson            Json? // Conditions to match before triggering
    inputMapping          Json? // How to map trigger payload to agent input
    isActive              Boolean                 @default(true)
    lastTriggeredAt       DateTime?
    triggerCount          Int                     @default(0)
    createdAt             DateTime                @default(now())
    updatedAt             DateTime                @updatedAt
    createdBy             String?
    TriggerEvent          TriggerEvent[]
    IntegrationConnection IntegrationConnection[]

    @@unique([webhookPath])
    @@index([agentId])
    @@index([workspaceId])
    @@index([triggerType])
    @@index([eventName])
    @@map("agent_trigger")
}

// Trigger Event - Unified execution origin log for agents, workflows, and networks
model TriggerEvent {
    id               String             @id @default(cuid())
    triggerId        String?
    trigger          AgentTrigger?      @relation(fields: [triggerId], references: [id], onDelete: SetNull)
    agentId          String?
    agent            Agent?             @relation(fields: [agentId], references: [id], onDelete: SetNull)
    workspaceId      String?
    workspace        Workspace?         @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    runId            String?
    run              AgentRun?          @relation(fields: [runId], references: [id], onDelete: SetNull)
    status           TriggerEventStatus @default(RECEIVED)
    sourceType       String // "webhook", "event", "integration", "schedule", "slack", "api", "chat", "mcp", "simulation"
    triggerType      String? // "webhook", "event", "mcp", "schedule"
    integrationKey   String? // e.g., "gmail"
    integrationId    String?
    eventName        String?
    webhookPath      String?
    payloadJson      Json?
    payloadPreview   String?            @db.Text
    payloadTruncated Boolean            @default(false)
    errorMessage     String?            @db.Text
    metadata         Json?

    // Entity type discrimination: "agent", "workflow", "network"
    entityType String?

    // Workflow support
    workflowId    String?
    workflow      Workflow?    @relation(fields: [workflowId], references: [id], onDelete: SetNull)
    workflowRunId String?      @unique
    workflowRun   WorkflowRun? @relation(fields: [workflowRunId], references: [id], onDelete: SetNull)

    // Network support
    networkId    String?
    network      Network?    @relation(fields: [networkId], references: [id], onDelete: SetNull)
    networkRunId String?     @unique
    networkRun   NetworkRun? @relation(fields: [networkRunId], references: [id], onDelete: SetNull)

    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
    ApprovalRequest ApprovalRequest[]

    @@unique([runId])
    @@index([triggerId, createdAt])
    @@index([agentId, createdAt])
    @@index([workspaceId, createdAt])
    @@index([status, createdAt])
    @@index([eventName])
    @@index([integrationKey])
    @@index([entityType, createdAt])
    @@index([workflowId, createdAt])
    @@index([networkId, createdAt])
    @@index([sourceType, createdAt])
    @@map("trigger_event")
}

// Gmail Integration - Links Gmail accounts to agents and Slack notifications
model GmailIntegration {
    id                      String                 @id @default(cuid())
    agentId                 String
    agent                   Agent                  @relation(fields: [agentId], references: [id], onDelete: Cascade)
    workspaceId             String?
    workspace               Workspace?             @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    integrationConnectionId String?
    integrationConnection   IntegrationConnection? @relation(fields: [integrationConnectionId], references: [id], onDelete: SetNull)
    gmailAddress            String
    slackUserId             String
    historyId               String?
    watchExpiration         DateTime?
    isActive                Boolean                @default(true)
    createdAt               DateTime               @default(now())
    updatedAt               DateTime               @updatedAt

    @@unique([agentId, gmailAddress])
    @@index([agentId])
    @@index([workspaceId])
    @@index([gmailAddress])
    @@index([integrationConnectionId])
    @@map("gmail_integration")
}

// Legacy Mastra tables (not managed by Prisma migrations)
model MastraAiSpan {
    traceId        String
    spanId         String
    name           String
    spanType       String
    isEvent        Boolean
    startedAt      DateTime  @db.Timestamp(6)
    parentSpanId   String?
    entityType     String?
    entityId       String?
    entityName     String?
    userId         String?
    organizationId String?
    resourceId     String?
    runId          String?
    sessionId      String?
    threadId       String?
    requestId      String?
    environment    String?
    source         String?
    serviceName    String?
    scope          Json?
    metadata       Json?
    tags           Json?
    attributes     Json?
    links          Json?
    input          Json?
    output         Json?
    error          Json?
    endedAt        DateTime? @db.Timestamp(6)
    createdAt      DateTime  @db.Timestamp(6)
    updatedAt      DateTime? @db.Timestamp(6)
    startedAtZ     DateTime? @default(now()) @db.Timestamptz(6)
    endedAtZ       DateTime? @default(now()) @db.Timestamptz(6)
    createdAtZ     DateTime? @default(now()) @db.Timestamptz(6)
    updatedAtZ     DateTime? @default(now()) @db.Timestamptz(6)

    @@id([traceId, spanId], map: "public_mastra_ai_spans_traceid_spanid_pk")
    @@index([entityType, entityId], map: "mastra_ai_spans_entitytype_entityid_idx")
    @@index([entityType, entityName], map: "mastra_ai_spans_entitytype_entityname_idx")
    @@index([metadata], map: "mastra_ai_spans_metadata_gin_idx", type: Gin)
    @@index([name])
    @@index([organizationId, userId], map: "mastra_ai_spans_orgid_userid_idx")
    @@index([parentSpanId, startedAt(sort: Desc)], map: "mastra_ai_spans_parentspanid_startedat_idx")
    @@index([spanType, startedAt(sort: Desc)], map: "mastra_ai_spans_spantype_startedat_idx")
    @@index([tags], map: "mastra_ai_spans_tags_gin_idx", type: Gin)
    @@index([traceId, startedAt(sort: Desc)], map: "mastra_ai_spans_traceid_startedat_idx")
    @@map("mastra_ai_spans")
    @@ignore
}

model MastraMessage {
    id         String    @id
    thread_id  String
    content    String
    role       String
    type       String
    createdAt  DateTime  @db.Timestamp(6)
    resourceId String?
    createdAtZ DateTime? @default(now()) @db.Timestamptz(6)

    @@index([thread_id, createdAt(sort: Desc)], map: "mastra_messages_thread_id_createdat_idx")
    @@map("mastra_messages")
    @@ignore
}

model MastraResource {
    id            String    @id
    workingMemory String?
    metadata      Json?
    createdAt     DateTime  @db.Timestamp(6)
    updatedAt     DateTime  @db.Timestamp(6)
    createdAtZ    DateTime? @default(now()) @db.Timestamptz(6)
    updatedAtZ    DateTime? @default(now()) @db.Timestamptz(6)

    @@map("mastra_resources")
    @@ignore
}

model MastraThread {
    id         String    @id
    resourceId String
    title      String
    metadata   Json?
    createdAt  DateTime  @db.Timestamp(6)
    updatedAt  DateTime  @db.Timestamp(6)
    createdAtZ DateTime? @default(now()) @db.Timestamptz(6)
    updatedAtZ DateTime? @default(now()) @db.Timestamptz(6)

    @@index([resourceId, createdAt(sort: Desc)], map: "mastra_threads_resourceid_createdat_idx")
    @@map("mastra_threads")
    @@ignore
}

// Legacy Stored Agents - Kept for backwards compatibility during migration
model StoredAgent {
    id            String   @id @default(cuid())
    name          String
    description   String?
    instructions  String   @db.Text
    modelProvider String // "openai", "anthropic", etc.
    modelName     String // "gpt-4o", "claude-sonnet", etc.
    temperature   Float?   @default(0.7)
    tools         String[] // Tool names to attach
    memory        Boolean  @default(false)
    metadata      Json?
    isActive      Boolean  @default(true)
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    @@map("stored_agent")
}

// ==============================
// Channel System Models
// ==============================

// Channel Session - Tracks conversations per channel/user
model ChannelSession {
    id         String   @id @default(cuid())
    channel    String // "whatsapp" | "telegram" | "voice"
    channelId  String // Phone number, chat ID, or call SID
    agentSlug  String // Which agent handles this conversation
    metadata   Json? // Channel-specific data (e.g., username, group info)
    lastActive DateTime @default(now())
    createdAt  DateTime @default(now())

    @@unique([channel, channelId])
    @@index([channel])
    @@index([agentSlug])
    @@map("channel_session")
}

// Channel Credentials - Stores encrypted credentials for each channel
model ChannelCredentials {
    id          String   @id @default(cuid())
    channel     String   @unique // "whatsapp" | "telegram" | "voice"
    credentials Json // Encrypted credentials (WhatsApp session, bot tokens, etc.)
    isActive    Boolean  @default(true)
    updatedAt   DateTime @updatedAt

    @@map("channel_credentials")
}

// Voice Call Log - Tracks voice call history
model VoiceCallLog {
    id           String    @id @default(cuid())
    callSid      String    @unique // Twilio call SID
    direction    String // "inbound" | "outbound"
    fromNumber   String
    toNumber     String
    agentSlug    String?
    status       String // "ringing" | "in-progress" | "completed" | "failed" | "busy" | "no-answer"
    duration     Int? // Duration in seconds
    recordingUrl String?
    transcript   String?   @db.Text
    metadata     Json?
    startedAt    DateTime  @default(now())
    endedAt      DateTime?
    createdAt    DateTime  @default(now())

    @@index([fromNumber])
    @@index([toNumber])
    @@index([agentSlug])
    @@map("voice_call_log")
}

// Voice Agent Trace - Full observability for voice agent conversations
model VoiceAgentTrace {
    id        String   @id @default(cuid())
    traceId   String   @unique // External trace ID
    timestamp DateTime @default(now())

    // Conversation content
    input  String @db.Text // User's question
    output String @db.Text // Agent's response

    // Model configuration
    model Json // {provider, name, temperature}

    // Tools
    availableTools String[] // Tool names available to agent
    toolCalls      Json // Array of {name, input, output, success, error, durationMs}

    // Execution trace
    steps Json // Array of {step, type, content, timestamp, toolCall?}

    // Performance
    durationMs Int
    tokens     Json? // {prompt, completion, total}

    // Evaluation scores
    scores Json // {helpfulness?: {score, reasoning}, relevancy?: {score}}

    // Metadata
    metadata Json // {source, agentSlug, agentSource, elevenlabsAgentId, maxSteps}

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([timestamp])
    @@index([createdAt])
    @@map("voice_agent_trace")
}

// ==============================
// Agent Workspace Models
// ==============================

// Agent Run - Execution history
model AgentRun {
    id               String    @id @default(cuid())
    agentId          String
    agent            Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId         String?
    runType          RunType   @default(PROD)
    status           RunStatus @default(QUEUED)
    inputText        String    @db.Text
    outputText       String?   @db.Text
    durationMs       Int?
    startedAt        DateTime  @default(now())
    completedAt      DateTime?
    modelProvider    String?
    modelName        String?
    versionId        String?
    promptTokens     Int?
    completionTokens Int?
    totalTokens      Int?
    costUsd          Float?
    userId           String?
    createdAt        DateTime  @default(now())

    // Conversation turn tracking (One Run = One Conversation)
    // For chat: turnCount > 0, tokens/cost are aggregates across turns
    // For non-chat (Slack, Voice, etc.): turnCount = 0, legacy single-message run
    turnCount Int @default(0)

    // Continuous Learning: Experiment linkage for shadow A/B testing
    experimentId    String? // Links run to active experiment for A/B testing
    experiment      LearningExperiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)
    experimentGroup String? // "baseline" or "candidate" - which version this run used

    // Skills active at run time [{skillId, skillSlug, skillVersion}]
    skillsJson Json?

    // Production channel tracking
    source      String? // "slack", "whatsapp", "voice", "telegram", "elevenlabs", "api", "test"
    triggerType RunTriggerType @default(API)
    triggerId   String?
    sessionId   String? // Channel session ID for conversation grouping
    threadId    String? // Thread/conversation ID within a channel

    // Relations
    turns           AgentRunTurn[]
    trace           AgentTrace?
    toolCalls       AgentToolCall[]
    workflowSteps   WorkflowRunStep[]
    evaluation      AgentEvaluation?
    feedbacks       AgentFeedback[]
    costEvents      CostEvent[]
    guardrailEvents GuardrailEvent[]
    conversation    AgentConversation?
    testRun         AgentTestRun?
    TriggerEvent    TriggerEvent?

    @@index([agentId, createdAt])
    @@index([status])
    @@index([tenantId])
    @@index([experimentId])
    @@index([source])
    @@index([sessionId])
    @@index([threadId])
    @@index([source, userId, createdAt]) // Rate limiting: per-user per-source
    @@index([source, threadId, createdAt]) // Rate limiting: per-org per-source via threadId prefix
    @@map("agent_run")
}

// Agent Run Turn - Individual message round-trips within a conversation run
model AgentRunTurn {
    id               String    @id @default(cuid())
    runId            String
    run              AgentRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
    turnIndex        Int // 0-based order within the conversation
    inputText        String    @db.Text
    outputText       String?   @db.Text
    durationMs       Int?
    startedAt        DateTime  @default(now())
    completedAt      DateTime?
    promptTokens     Int?
    completionTokens Int?
    totalTokens      Int?
    costUsd          Float?
    modelProvider    String?
    modelName        String?
    stepsJson        Json? // Execution steps for this turn
    createdAt        DateTime  @default(now())

    // Relations
    toolCalls  AgentToolCall[]
    costEvents CostEvent[]
    feedbacks  AgentFeedback[]

    @@unique([runId, turnIndex])
    @@index([runId, turnIndex])
    @@map("agent_run_turn")
}

// Agent Trace - Detailed execution trace per run
model AgentTrace {
    id                   String    @id @default(cuid())
    runId                String    @unique
    run                  AgentRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
    agentId              String
    agent                Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId             String?
    status               RunStatus @default(RUNNING)
    inputText            String    @db.Text
    outputText           String?   @db.Text
    durationMs           Int?
    stepsJson            Json? // Array of execution steps
    modelJson            Json? // Model configuration used
    tokensJson           Json? // Token counts
    scoresJson           Json? // Evaluation scores
    instructionsHash     String? // SHA-256 of merged instructions (base + skills)
    instructionsSnapshot String?   @db.Text // Full merged instructions for audit
    createdAt            DateTime  @default(now())

    // Relations
    steps     AgentTraceStep[]
    toolCalls AgentToolCall[]

    @@index([runId])
    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("agent_trace")
}

// Agent Trace Step - Individual execution steps
model AgentTraceStep {
    id         String     @id @default(cuid())
    traceId    String
    trace      AgentTrace @relation(fields: [traceId], references: [id], onDelete: Cascade)
    tenantId   String?
    stepNumber Int
    type       String // "llm" | "tool" | "memory" | "guardrail"
    content    Json // Step-specific content
    timestamp  DateTime   @default(now())
    durationMs Int?

    @@index([traceId, stepNumber])
    @@index([tenantId])
    @@map("agent_trace_step")
}

// Agent Tool Call - Tool call records
model AgentToolCall {
    id          String        @id @default(cuid())
    runId       String?
    run         AgentRun?     @relation(fields: [runId], references: [id], onDelete: Cascade)
    traceId     String?
    trace       AgentTrace?   @relation(fields: [traceId], references: [id], onDelete: Cascade)
    turnId      String?
    turn        AgentRunTurn? @relation(fields: [turnId], references: [id], onDelete: Cascade)
    tenantId    String?
    toolKey     String
    mcpServerId String?
    toolSource  String? // "registry", "mcp:hubspot", "skill:research-assistant"
    inputJson   Json?
    outputJson  Json?
    success     Boolean       @default(true)
    error       String?       @db.Text
    durationMs  Int?
    createdAt   DateTime      @default(now())

    @@index([runId])
    @@index([turnId])
    @@index([traceId, toolKey])
    @@index([tenantId])
    @@map("agent_tool_call")
}

// Agent Alert - System/budget/guardrail alerts
model AgentAlert {
    id         String        @id @default(cuid())
    agentId    String
    agent      Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId   String?
    severity   AlertSeverity @default(INFO)
    message    String        @db.Text
    source     AlertSource   @default(SYSTEM)
    createdAt  DateTime      @default(now())
    resolvedAt DateTime?

    @@index([agentId, createdAt, severity])
    @@index([tenantId])
    @@map("agent_alert")
}

// Audit Log - All write operations
model AuditLog {
    id         String   @id @default(cuid())
    tenantId   String?
    actorId    String? // User ID who performed the action
    action     String // AGENT_CREATE, AGENT_UPDATE, CONFIG_CHANGE, etc.
    entityType String // Agent, AgentVersion, etc.
    entityId   String
    metadata   Json? // Additional context
    createdAt  DateTime @default(now())

    @@index([tenantId, createdAt])
    @@index([entityId])
    @@map("audit_log")
}

// Agent Evaluation - Evaluation scores per run
model AgentEvaluation {
    id            String   @id @default(cuid())
    runId         String   @unique
    run           AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    scoresJson    Json // {relevancy: 0.9, toxicity: 0.1, ...}
    scorerVersion String?
    createdAt     DateTime @default(now())

    @@index([runId])
    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("agent_evaluation")
}

// Agent Feedback - User feedback per turn or per conversation
model AgentFeedback {
    id        String        @id @default(cuid())
    runId     String
    run       AgentRun      @relation(fields: [runId], references: [id], onDelete: Cascade)
    turnId    String?
    turn      AgentRunTurn? @relation(fields: [turnId], references: [id], onDelete: Cascade)
    agentId   String
    agent     Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId  String?
    thumbs    Boolean? // true = up, false = down
    rating    Int? // 1-5 scale
    comment   String?       @db.Text
    createdAt DateTime      @default(now())

    @@index([runId])
    @@index([turnId])
    @@index([agentId])
    @@index([tenantId])
    @@map("agent_feedback")
}

// Agent Test Case - Stored test cases
model AgentTestCase {
    id             String   @id @default(cuid())
    agentId        String
    agent          Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId       String?
    name           String
    inputText      String   @db.Text
    expectedOutput String?  @db.Text
    tags           String[] @default([])
    createdBy      String?
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    // Relations
    testRuns AgentTestRun[]

    @@index([agentId])
    @@index([tenantId])
    @@map("agent_test_case")
}

// Agent Test Run - Test execution results
model AgentTestRun {
    id         String        @id @default(cuid())
    testCaseId String
    testCase   AgentTestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
    agentId    String
    agent      Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId   String?
    versionId  String?
    runId      String?       @unique
    run        AgentRun?     @relation(fields: [runId], references: [id], onDelete: SetNull)
    outputText String?       @db.Text
    passed     Boolean?
    score      Float?
    durationMs Int?
    tokens     Int?
    createdAt  DateTime      @default(now())

    @@index([testCaseId])
    @@index([agentId])
    @@index([tenantId])
    @@map("agent_test_run")
}

// Agent Conversation - Multi-turn conversation persistence
model AgentConversation {
    id           String    @id @default(cuid())
    agentId      String
    agent        Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId     String?
    runId        String?   @unique
    run          AgentRun? @relation(fields: [runId], references: [id], onDelete: SetNull)
    messagesJson Json // Array of {role, content, timestamp}
    createdAt    DateTime  @default(now())

    @@index([agentId])
    @@index([tenantId])
    @@map("agent_conversation")
}

// Budget Policy - Per-agent budget settings
model BudgetPolicy {
    id              String   @id @default(cuid())
    agentId         String   @unique
    agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId        String?
    enabled         Boolean  @default(false)
    monthlyLimitUsd Float?
    alertAtPct      Float?   @default(80) // Alert when usage reaches this percentage
    hardLimit       Boolean  @default(false) // Block runs when limit exceeded
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    @@index([agentId])
    @@index([tenantId])
    @@map("budget_policy")
}

// Cost Event - Token/cost tracking per run
model CostEvent {
    id               String        @id @default(cuid())
    runId            String
    run              AgentRun      @relation(fields: [runId], references: [id], onDelete: Cascade)
    turnId           String?
    turn             AgentRunTurn? @relation(fields: [turnId], references: [id], onDelete: Cascade)
    agentId          String
    agent            Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId         String?
    provider         String
    modelName        String
    promptTokens     Int?
    completionTokens Int?
    totalTokens      Int?
    costUsd          Float?
    createdAt        DateTime      @default(now())

    @@index([runId])
    @@index([turnId])
    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("cost_event")
}

// Agent Cost Daily - Daily cost rollups
model AgentCostDaily {
    id                String   @id @default(cuid())
    agentId           String
    agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId          String?
    date              DateTime @db.Date
    totalCostUsd      Float    @default(0)
    promptCostUsd     Float    @default(0)
    completionCostUsd Float    @default(0)
    runs              Int      @default(0)

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("agent_cost_daily")
}

// Agent Model Cost Daily - Cost by model per day
model AgentModelCostDaily {
    id        String   @id @default(cuid())
    agentId   String
    agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId  String?
    modelName String
    date      DateTime @db.Date
    costUsd   Float    @default(0)
    tokens    Int      @default(0)
    runs      Int      @default(0)

    @@unique([agentId, modelName, date])
    @@index([agentId, modelName, date])
    @@index([tenantId])
    @@map("agent_model_cost_daily")
}

// Cost Recommendation - AI-generated savings tips
model CostRecommendation {
    id                  String   @id @default(cuid())
    agentId             String
    agent               Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId            String?
    type                String // "model_switch", "prompt_optimization", etc.
    title               String
    description         String   @db.Text
    estimatedSavingsUsd Float?
    createdAt           DateTime @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("cost_recommendation")
}

// Guardrail Policy - Per-agent guardrail config
model GuardrailPolicy {
    id         String   @id @default(cuid())
    agentId    String   @unique
    agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId   String?
    configJson Json // Full guardrail configuration
    version    Int      @default(1)
    createdBy  String?
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@index([agentId])
    @@index([tenantId])
    @@map("guardrail_policy")
}

// Guardrail Event - Blocked/modified/flagged events
model GuardrailEvent {
    id            String             @id @default(cuid())
    agentId       String
    agent         Agent              @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    runId         String?
    run           AgentRun?          @relation(fields: [runId], references: [id], onDelete: SetNull)
    type          GuardrailEventType
    guardrailKey  String
    reason        String             @db.Text
    inputSnippet  String?            @db.Text
    outputSnippet String?            @db.Text
    createdAt     DateTime           @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("guardrail_event")
}

// Agent Stats Daily - Daily KPI rollups
model AgentStatsDaily {
    id              String   @id @default(cuid())
    agentId         String
    agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId        String?
    date            DateTime @db.Date
    totalRuns       Int      @default(0)
    successRate     Float?
    avgDurationMs   Float?
    avgQualityScore Float?
    totalCostUsd    Float    @default(0)

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("agent_stats_daily")
}

// Agent Metric Daily - Performance metrics
model AgentMetricDaily {
    id           String   @id @default(cuid())
    agentId      String
    agent        Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId     String?
    date         DateTime @db.Date
    runs         Int      @default(0)
    successRate  Float?
    avgLatencyMs Float?
    errorRate    Float?
    qualityScore Float?

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("agent_metric_daily")
}

// Agent Tool Metric Daily - Tool usage metrics
model AgentToolMetricDaily {
    id            String   @id @default(cuid())
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    toolKey       String
    date          DateTime @db.Date
    callCount     Int      @default(0)
    successRate   Float?
    avgDurationMs Float?

    @@unique([agentId, toolKey, date])
    @@index([agentId, toolKey, date])
    @@index([tenantId])
    @@map("agent_tool_metric_daily")
}

// Agent Model Metric Daily - Model comparison metrics
model AgentModelMetricDaily {
    id            String   @id @default(cuid())
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    modelProvider String
    modelName     String
    date          DateTime @db.Date
    runs          Int      @default(0)
    avgLatencyMs  Float?
    qualityScore  Float?
    costUsd       Float    @default(0)

    @@unique([agentId, modelName, date])
    @@index([agentId, modelName, date])
    @@index([tenantId])
    @@map("agent_model_metric_daily")
}

// Agent Quality Metric Daily - Quality score rollups
model AgentQualityMetricDaily {
    id          String   @id @default(cuid())
    agentId     String
    agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId    String?
    scorerKey   String
    date        DateTime @db.Date
    avgScore    Float?
    sampleCount Int      @default(0)

    @@unique([agentId, scorerKey, date])
    @@index([agentId, scorerKey, date])
    @@index([tenantId])
    @@map("agent_quality_metric_daily")
}

// Agent Feedback Aggregate Daily - Feedback summaries
model AgentFeedbackAggregateDaily {
    id            String   @id @default(cuid())
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    date          DateTime @db.Date
    positiveCount Int      @default(0)
    negativeCount Int      @default(0)

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("agent_feedback_aggregate_daily")
}

// Agent Version Stats - Per-version performance
model AgentVersionStats {
    id          String       @id @default(cuid())
    versionId   String
    version     AgentVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
    agentId     String
    agent       Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId    String?
    runs        Int          @default(0)
    successRate Float?
    avgQuality  Float?
    updatedAt   DateTime     @updatedAt

    @@unique([versionId])
    @@index([versionId])
    @@index([tenantId])
    @@map("agent_version_stats")
}

// Evaluation Theme - Feedback theme extraction
model EvaluationTheme {
    id        String   @id @default(cuid())
    agentId   String
    agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId  String?
    theme     String
    sentiment String? // "positive", "negative", "neutral"
    count     Int      @default(0)
    createdAt DateTime @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("evaluation_theme")
}

// Insight - AI-generated insights
model Insight {
    id          String   @id @default(cuid())
    agentId     String
    agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId    String?
    type        String // "performance", "cost", "quality", etc.
    title       String
    description String   @db.Text
    createdAt   DateTime @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("insight")
}

// ==============================
// Closed-Loop Learning Models
// ==============================

// Learning Session Status Enum
enum LearningSessionStatus {
    COLLECTING // Gathering runs for analysis
    ANALYZING // Extracting signals from runs
    PROPOSING // Generating improvement proposals
    TESTING // Running A/B experiments
    AWAITING_APPROVAL // Waiting for human approval
    APPROVED // Approved and promoting
    REJECTED // Rejected by human
    PROMOTED // Successfully promoted new version
    FAILED // Failed during processing
}

// Learning Experiment Status Enum
enum LearningExperimentStatus {
    PENDING // Not started
    RUNNING // A/B test in progress
    COMPLETED // Test finished
    PASSED // Candidate beat baseline
    FAILED // Candidate did not beat baseline
}

// Learning Signal Type Enum
enum LearningSignalType {
    LOW_SCORE // Run scored below threshold
    TOOL_FAILURE // Tool call failed
    GUARDRAIL_HIT // Guardrail triggered
    NEGATIVE_FEEDBACK // User gave negative feedback
    HIGH_LATENCY // Run took too long
    ERROR // Run failed with error
    PATTERN // Detected pattern across runs
    SKILL_CORRELATION // Skill correlated with poor performance
}

// Risk Tier Enum for Continuous Learning
enum RiskTier {
    LOW // Safe for auto-promotion (instruction-only edits)
    MEDIUM // Requires review but not high-risk
    HIGH // Requires human approval (model/tool/memory changes)
}

// Learning Session - Orchestrates each closed-loop learning cycle
model LearningSession {
    id              String                @id @default(cuid())
    agentId         String
    agent           Agent                 @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId        String?
    status          LearningSessionStatus @default(COLLECTING)
    runCount        Int                   @default(0) // Number of runs analyzed
    datasetHash     String? // SHA256 hash of run IDs for provenance
    baselineVersion Int? // Agent version at start
    scorerConfig    Json? // Scorer configuration used
    thresholdsJson  Json? // Gating thresholds for A/B test
    metadata        Json? // Additional context
    createdBy       String?
    createdAt       DateTime              @default(now())
    updatedAt       DateTime              @updatedAt
    completedAt     DateTime?

    // Relations
    dataset     LearningDataset?
    signals     LearningSignal[]
    proposals   LearningProposal[]
    experiments LearningExperiment[]
    approval    LearningApproval?

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@index([status])
    @@map("learning_session")
}

// Learning Dataset - Snapshot of runs used for learning
model LearningDataset {
    id                String          @id @default(cuid())
    sessionId         String          @unique
    session           LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    tenantId          String?
    runIds            String[] // Array of AgentRun IDs included
    selectionCriteria Json? // Criteria used to select runs
    datasetHash       String // SHA256 hash for reproducibility
    fromDate          DateTime? // Start of time range
    toDate            DateTime? // End of time range
    runCount          Int             @default(0)
    avgScore          Float? // Average quality score
    createdAt         DateTime        @default(now())

    @@index([sessionId])
    @@index([tenantId])
    @@index([datasetHash])
    @@map("learning_dataset")
}

// Learning Signal - Extracted patterns from runs
model LearningSignal {
    id           String             @id @default(cuid())
    sessionId    String
    session      LearningSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    tenantId     String?
    type         LearningSignalType
    severity     String? // "low", "medium", "high"
    pattern      String             @db.Text // Description of the pattern
    evidenceJson Json? // Run IDs and specific examples
    frequency    Int                @default(1) // How often this occurred
    impact       Float? // Estimated impact score
    createdAt    DateTime           @default(now())

    @@index([sessionId])
    @@index([tenantId])
    @@index([type])
    @@map("learning_signal")
}

// Learning Proposal - Proposed changes to improve agent
model LearningProposal {
    id                 String          @id @default(cuid())
    sessionId          String
    session            LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    tenantId           String?
    proposalType       String // "instructions", "tools", "memory", "model", "combined"
    title              String
    description        String          @db.Text
    instructionsDiff   String?         @db.Text // Unified diff of instructions change
    toolChangesJson    Json? // {added: [], removed: [], modified: []}
    memoryChangesJson  Json? // Changes to memory config
    modelChangesJson   Json? // Changes to model config
    expectedImpact     String?         @db.Text // Expected improvement
    confidenceScore    Float? // 0-1 confidence in proposal
    generatedBy        String? // "llm", "heuristic", "human"
    candidateVersionId String? // Created AgentVersion ID if built
    isSelected         Boolean         @default(false) // Selected for testing
    createdAt          DateTime        @default(now())

    // Continuous Learning: Risk assessment fields
    riskTier     RiskTier? // LOW, MEDIUM, HIGH - determines auto-promotion eligibility
    autoEligible Boolean   @default(false) // Whether this can be auto-promoted
    riskReasons  Json? // Array of reasons for risk classification

    // Relations
    experiments LearningExperiment[]

    @@index([sessionId])
    @@index([tenantId])
    @@index([riskTier])
    @@map("learning_proposal")
}

// Learning Experiment - A/B test configuration and results
model LearningExperiment {
    id                 String                   @id @default(cuid())
    sessionId          String
    session            LearningSession          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    proposalId         String
    proposal           LearningProposal         @relation(fields: [proposalId], references: [id], onDelete: Cascade)
    tenantId           String?
    status             LearningExperimentStatus @default(PENDING)
    baselineVersionId  String? // Current agent version
    candidateVersionId String? // New version to test
    testCaseIds        String[] // Test cases used
    syntheticTestCount Int                      @default(0) // Generated test count
    baselineMetrics    Json? // {avgScore, successRate, latency, etc.}
    candidateMetrics   Json? // Same structure as baseline
    gatingThreshold    Float                    @default(0.5) // Win rate needed
    winRate            Float? // Candidate win rate
    confidenceInterval Json? // {lower, upper}
    gatingResult       String? // "passed", "failed", "inconclusive"
    startedAt          DateTime?
    completedAt        DateTime?
    createdAt          DateTime                 @default(now())

    // Continuous Learning: Real-traffic shadow testing fields
    trafficSplit      Json? // {baseline: 0.9, candidate: 0.1} - traffic allocation
    shadowRunCount    Int   @default(0) // Total runs in shadow test
    baselineRunCount  Int   @default(0) // Runs routed to baseline
    candidateRunCount Int   @default(0) // Runs routed to candidate

    // Relations
    runs AgentRun[] // Runs tagged to this experiment

    @@index([sessionId])
    @@index([proposalId])
    @@index([tenantId])
    @@index([status])
    @@map("learning_experiment")
}

// Learning Approval - Human or auto decision on proposals
model LearningApproval {
    id                String          @id @default(cuid())
    sessionId         String          @unique
    session           LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    tenantId          String?
    decision          String // "approved", "rejected", "deferred", "auto_approved"
    rationale         String?         @db.Text
    approvedBy        String? // User ID (null for auto-approval)
    promotedVersionId String? // New AgentVersion ID if promoted
    reviewedAt        DateTime?
    createdAt         DateTime        @default(now())

    // Continuous Learning: Auto-promotion tracking
    autoApproved Boolean @default(false) // Whether this was auto-approved

    @@index([sessionId])
    @@index([tenantId])
    @@index([autoApproved])
    @@map("learning_approval")
}

// Learning Policy - Per-agent continuous learning configuration
model LearningPolicy {
    id                   String    @id @default(cuid())
    agentId              String    @unique
    agent                Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId             String?
    enabled              Boolean   @default(true) // Master switch for continuous learning
    autoPromotionEnabled Boolean   @default(false) // Allow auto-promotion for low-risk changes
    scheduledEnabled     Boolean   @default(true) // Enable scheduled backstop triggers
    thresholdEnabled     Boolean   @default(true) // Enable signal threshold triggers
    paused               Boolean   @default(false) // Temporarily pause learning
    pausedUntil          DateTime? // Auto-resume after this time

    // Thresholds and configuration (can override global defaults)
    signalThreshold       Int? // Signals needed to trigger session
    signalWindowMinutes   Int? // Time window for signal accumulation
    trafficSplitCandidate Float? // Default candidate traffic split (e.g., 0.1 = 10%)
    minConfidenceForAuto  Float? // Minimum confidence score for auto-promotion
    minWinRateForAuto     Float? // Minimum win rate for auto-promotion

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    updatedBy String?

    @@index([agentId])
    @@index([tenantId])
    @@map("learning_policy")
}

// Learning Metric Daily - Daily closed-loop learning KPIs
model LearningMetricDaily {
    id                 String   @id @default(cuid())
    agentId            String
    agent              Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId           String?
    date               DateTime @db.Date
    sessionsStarted    Int      @default(0)
    sessionsCompleted  Int      @default(0)
    proposalsGenerated Int      @default(0)
    proposalsApproved  Int      @default(0)
    proposalsRejected  Int      @default(0)
    experimentsRun     Int      @default(0)
    experimentsPassed  Int      @default(0)
    versionsPromoted   Int      @default(0)
    avgImprovementPct  Float? // Average quality improvement
    evalCoverage       Float? // Percentage of runs evaluated

    // Continuous Learning: Auto vs Manual tracking
    autoPromotions    Int @default(0) // Promotions via auto-approval
    manualPromotions  Int @default(0) // Promotions via human approval
    shadowRunCount    Int @default(0) // Runs in shadow A/B tests
    baselineRunCount  Int @default(0) // Runs routed to baseline
    candidateRunCount Int @default(0) // Runs routed to candidate
    regressionCount   Int @default(0) // Guardrail regressions detected
    scheduledTriggers Int @default(0) // Sessions started via schedule
    thresholdTriggers Int @default(0) // Sessions started via signal threshold

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("learning_metric_daily")
}

// ==============================
// Simulation System Models
// ==============================

// Simulation Session - Tracks a batch of simulated conversations for testing agents
model SimulationSession {
    id      String @id @default(cuid())
    agentId String
    agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
    theme   String @db.Text // "Customer service about timesheets"
    status  String @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, CANCELLED

    // Configuration
    targetCount Int @default(100)
    concurrency Int @default(5)

    // Progress
    completedCount Int @default(0)
    failedCount    Int @default(0)

    // Results (computed when complete)
    avgQualityScore Float?
    avgDurationMs   Float?
    successRate     Float?
    totalCostUsd    Float?

    // Timing
    startedAt   DateTime?
    completedAt DateTime?
    createdAt   DateTime  @default(now())

    @@index([agentId, createdAt])
    @@index([status])
    @@map("simulation_session")
}

// ==============================
// Workflow + Network Workspace Models
// ==============================

// Workflow Definition
model Workflow {
    id          String  @id @default(cuid())
    slug        String  @unique
    name        String
    description String? @db.Text

    // Visual definition (React Flow compatible)
    definitionJson Json // { nodes: [], edges: [], viewport: {} }

    // Compiled representation (cached)
    compiledJson Json?
    compiledAt   DateTime?
    compiledHash String?

    // Schemas
    inputSchemaJson  Json?
    outputSchemaJson Json?

    // Configuration
    maxSteps    Int   @default(50)
    timeout     Int?
    retryConfig Json?

    // Status
    isPublished Boolean @default(false)
    isActive    Boolean @default(true)
    version     Int     @default(1)

    // Tenancy
    workspaceId String?
    workspace   Workspace?   @relation(fields: [workspaceId], references: [id])
    ownerId     String?
    type        WorkflowType @default(USER)

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    createdBy String?

    // Relations
    versions          WorkflowVersion[]
    runs              WorkflowRun[]
    networkPrimitives NetworkPrimitive[]
    metrics           WorkflowMetricDaily[]
    triggerEvents     TriggerEvent[]

    @@index([slug])
    @@index([workspaceId])
    @@index([isPublished])
    @@map("workflow")
}

// Workflow Version History
model WorkflowVersion {
    id             String   @id @default(cuid())
    workflowId     String
    workflow       Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
    version        Int
    definitionJson Json
    description    String?  @db.Text
    createdAt      DateTime @default(now())
    createdBy      String?

    @@unique([workflowId, version])
    @@index([workflowId])
    @@map("workflow_version")
}

// Workflow Execution
model WorkflowRun {
    id         String    @id @default(cuid())
    workflowId String
    workflow   Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
    status     RunStatus @default(QUEUED)

    // Input/Output
    inputJson  Json
    outputJson Json?

    // Suspension (human-in-the-loop)
    suspendedAt     DateTime?
    suspendedStep   String?
    suspendDataJson Json?
    resumedAt       DateTime?
    resumeDataJson  Json?

    // Execution stats
    durationMs  Int?
    startedAt   DateTime  @default(now())
    completedAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    // Version tracking
    versionId String?

    // Source tracking
    source       String?
    environment  RunEnvironment @default(DEVELOPMENT)
    triggerType  RunTriggerType @default(API)
    triggerId    String?
    networkRunId String?
    networkRun   NetworkRun?    @relation(fields: [networkRunId], references: [id])

    // Relations
    steps           WorkflowRunStep[]
    ApprovalRequest ApprovalRequest[]
    TriggerEvent    TriggerEvent?

    @@index([workflowId, createdAt])
    @@index([workflowId, environment])
    @@index([workflowId, triggerType])
    @@index([status])
    @@map("workflow_run")
}

// Workflow Step Execution
model WorkflowRunStep {
    id    String      @id @default(cuid())
    runId String
    run   WorkflowRun @relation(fields: [runId], references: [id], onDelete: Cascade)

    stepId   String
    stepType String
    stepName String?

    status     RunStatus @default(QUEUED)
    inputJson  Json?
    outputJson Json?
    errorJson  Json?

    // For loops
    iterationIndex Int?

    // Timing
    startedAt   DateTime?
    completedAt DateTime?
    durationMs  Int?

    // Nested execution
    agentRunId String?
    agentRun   AgentRun? @relation(fields: [agentRunId], references: [id], onDelete: SetNull)

    @@index([runId])
    @@index([stepId])
    @@map("workflow_run_step")
}

// Network Definition
model Network {
    id          String  @id @default(cuid())
    slug        String  @unique
    name        String
    description String? @db.Text

    // Routing agent configuration
    instructions  String @db.Text
    modelProvider String
    modelName     String
    temperature   Float? @default(0.7)

    // Visual topology
    topologyJson Json

    // Memory configuration (required for networks)
    memoryConfig Json

    // Execution settings
    maxSteps Int @default(10)

    // Status
    isPublished Boolean @default(false)
    isActive    Boolean @default(true)
    version     Int     @default(1)

    // Tenancy
    workspaceId String?
    workspace   Workspace?  @relation(fields: [workspaceId], references: [id])
    ownerId     String?
    type        NetworkType @default(USER)

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    createdBy String?

    // Relations
    primitives    NetworkPrimitive[]
    versions      NetworkVersion[]
    runs          NetworkRun[]
    metrics       NetworkMetricDaily[]
    triggerEvents TriggerEvent[]

    @@index([slug])
    @@index([workspaceId])
    @@index([isPublished])
    @@map("network")
}

// Network Primitive Junction
model NetworkPrimitive {
    id        String  @id @default(cuid())
    networkId String
    network   Network @relation(fields: [networkId], references: [id], onDelete: Cascade)

    primitiveType String // "agent", "workflow", "tool"

    // Reference (one of these will be set)
    agentId    String?
    agent      Agent?    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    workflowId String?
    workflow   Workflow? @relation(fields: [workflowId], references: [id], onDelete: Cascade)
    toolId     String?

    // Override description for routing
    description String? @db.Text

    // Position in visual topology
    position Json?

    createdAt DateTime @default(now())

    @@unique([networkId, agentId])
    @@unique([networkId, workflowId])
    @@unique([networkId, toolId])
    @@index([networkId])
    @@map("network_primitive")
}

// Network Version History
model NetworkVersion {
    id             String   @id @default(cuid())
    networkId      String
    network        Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
    version        Int
    topologyJson   Json
    primitivesJson Json
    description    String?  @db.Text
    createdAt      DateTime @default(now())
    createdBy      String?

    @@unique([networkId, version])
    @@index([networkId])
    @@map("network_version")
}

// Network Execution
model NetworkRun {
    id        String    @id @default(cuid())
    networkId String
    network   Network   @relation(fields: [networkId], references: [id], onDelete: Cascade)
    status    RunStatus @default(QUEUED)

    // Input/Output
    inputText  String  @db.Text
    outputText String? @db.Text
    outputJson Json?

    // Thread/Memory
    threadId   String?
    resourceId String?

    // Stats
    stepsExecuted Int?
    durationMs    Int?
    startedAt     DateTime  @default(now())
    completedAt   DateTime?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    // Token usage
    totalTokens  Int?
    totalCostUsd Float?

    // Version tracking
    versionId String?

    // Source
    source      String?
    environment RunEnvironment @default(DEVELOPMENT)
    triggerType RunTriggerType @default(API)

    // Relations
    steps        NetworkRunStep[]
    workflowRuns WorkflowRun[]
    TriggerEvent TriggerEvent?

    @@index([networkId, createdAt])
    @@index([networkId, environment])
    @@index([networkId, triggerType])
    @@index([status])
    @@index([threadId])
    @@map("network_run")
}

// Network Step Execution
model NetworkRunStep {
    id    String     @id @default(cuid())
    runId String
    run   NetworkRun @relation(fields: [runId], references: [id], onDelete: Cascade)

    stepNumber Int
    stepType   String // "routing", "agent", "workflow", "tool"

    // What was executed
    primitiveType String?
    primitiveId   String?

    // Routing decision (for routing steps)
    routingDecision Json?

    // Execution details
    inputJson  Json?
    outputJson Json?
    errorJson  Json?

    status      RunStatus @default(QUEUED)
    startedAt   DateTime?
    completedAt DateTime?
    durationMs  Int?

    // Token usage for this step
    tokens  Int?
    costUsd Float?

    @@index([runId])
    @@index([stepNumber])
    @@map("network_run_step")
}

// Workflow Daily Metrics
model WorkflowMetricDaily {
    id               String   @id @default(cuid())
    workflowId       String
    workflow         Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
    date             DateTime @db.Date
    runs             Int      @default(0)
    successRate      Float?
    avgDurationMs    Float?
    suspensionRate   Float?
    avgStepsExecuted Float?

    @@unique([workflowId, date])
    @@map("workflow_metric_daily")
}

// Network Daily Metrics
model NetworkMetricDaily {
    id                  String   @id @default(cuid())
    networkId           String
    network             Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
    date                DateTime @db.Date
    runs                Int      @default(0)
    successRate         Float?
    avgDurationMs       Float?
    avgStepsExecuted    Float?
    avgRoutingDecisions Float?
    totalCostUsd        Float?

    // Primitive usage breakdown
    agentCallCount    Int @default(0)
    workflowCallCount Int @default(0)
    toolCallCount     Int @default(0)

    @@unique([networkId, date])
    @@map("network_metric_daily")
}

// Deployment Lifecycle
model Deployment {
    id String @id @default(cuid())

    // What is being deployed
    entityType String // "agent", "workflow", "network"
    entityId   String
    versionId  String

    // Environment
    environment String
    status      DeploymentStatus @default(DRAFT)

    // Approval
    approvedBy String?
    approvedAt DateTime?

    // Traffic
    trafficPercent Float?

    // Rollback
    previousDeploymentId String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([entityType, entityId, environment])
    @@index([entityType, entityId])
    @@map("deployment")
}

// BIM Version Status Enum
enum BimVersionStatus {
    QUEUED
    PROCESSING
    READY
    FAILED
}

// BIM Model
model BimModel {
    id           String  @id @default(cuid())
    name         String
    description  String? @db.Text
    sourceSystem String?
    metadata     Json?

    // Tenancy
    workspaceId String?
    workspace   Workspace? @relation(fields: [workspaceId], references: [id])
    ownerId     String?

    // Relations
    versions BimModelVersion[]
    takeoffs BimTakeoff[]
    diffs    BimDiffSummary[]
    clashes  BimClash[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([workspaceId])
    @@map("bim_model")
}

// BIM Model Version
model BimModelVersion {
    id String @id @default(cuid())

    modelId String
    model   BimModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

    version      Int              @default(1)
    status       BimVersionStatus @default(QUEUED)
    sourceFormat String
    sourceUri    String?
    sourceKey    String?
    checksum     String?
    metadata     Json?

    // Relations
    elements  BimElement[]
    takeoffs  BimTakeoff[]
    clashes   BimClash[]
    diffsFrom BimDiffSummary[] @relation("BimDiffFrom")
    diffsTo   BimDiffSummary[] @relation("BimDiffTo")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([modelId, version])
    @@index([modelId])
    @@index([status])
    @@map("bim_model_version")
}

// BIM Element
model BimElement {
    id String @id @default(cuid())

    versionId String
    version   BimModelVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

    elementGuid String
    name        String?
    category    String?
    type        String?
    family      String?
    system      String?
    level       String?
    phase       String?
    description String? @db.Text
    properties  Json?

    geometrySummary BimGeometrySummary?
    propertyEntries BimElementProperty[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([versionId, elementGuid])
    @@index([versionId])
    @@index([category])
    @@index([system])
    @@map("bim_element")
}

// BIM Element Geometry Summary
model BimGeometrySummary {
    id String @id @default(cuid())

    elementId String     @unique
    element   BimElement @relation(fields: [elementId], references: [id], onDelete: Cascade)

    bboxMin  Json?
    bboxMax  Json?
    centroid Json?
    length   Float?
    area     Float?
    volume   Float?
    units    String?
    metadata Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([elementId])
    @@map("bim_geometry_summary")
}

// BIM Element Properties (normalized)
model BimElementProperty {
    id String @id @default(cuid())

    elementId String
    element   BimElement @relation(fields: [elementId], references: [id], onDelete: Cascade)

    group        String?
    name         String
    valueString  String?
    valueNumber  Float?
    valueBoolean Boolean?
    unit         String?
    rawValue     Json?

    createdAt DateTime @default(now())

    @@index([elementId])
    @@index([name])
    @@map("bim_element_property")
}

// BIM Takeoff Results
model BimTakeoff {
    id String @id @default(cuid())

    modelId String?
    model   BimModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)

    versionId String
    version   BimModelVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

    scope     String?
    query     Json?
    result    Json
    createdBy String?

    createdAt DateTime @default(now())

    @@index([versionId])
    @@map("bim_takeoff")
}

// BIM Clash Results
model BimClash {
    id String @id @default(cuid())

    modelId String?
    model   BimModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)

    versionId String
    version   BimModelVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

    query     Json?
    result    Json
    createdBy String?

    createdAt DateTime @default(now())

    @@index([versionId])
    @@map("bim_clash")
}

// BIM Diff Summary
model BimDiffSummary {
    id String @id @default(cuid())

    modelId String?
    model   BimModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)

    fromVersionId String
    fromVersion   BimModelVersion @relation("BimDiffFrom", fields: [fromVersionId], references: [id], onDelete: Cascade)

    toVersionId String
    toVersion   BimModelVersion @relation("BimDiffTo", fields: [toVersionId], references: [id], onDelete: Cascade)

    summary   Json
    createdBy String?

    createdAt DateTime @default(now())

    @@index([fromVersionId])
    @@index([toVersionId])
    @@map("bim_diff_summary")
}

// ==============================
// Document Primitive
// ==============================

model Document {
    id          String  @id @default(cuid())
    slug        String  @unique
    name        String
    description String? @db.Text
    content     String  @db.Text
    contentType String  @default("markdown")

    vectorIds  String[]
    chunkCount Int       @default(0)
    embeddedAt DateTime?

    category String?
    tags     String[]
    metadata Json?

    workspaceId String?
    workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

    version  Int               @default(1)
    versions DocumentVersion[]
    skills   SkillDocument[]

    type      String   @default("USER") @map("doc_type")
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    createdBy String?

    @@index([workspaceId])
    @@index([category])
    @@map("document")
}

model DocumentVersion {
    id            String   @id @default(cuid())
    documentId    String
    document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
    version       Int
    content       String   @db.Text
    changeSummary String?
    createdAt     DateTime @default(now())
    createdBy     String?

    @@unique([documentId, version])
    @@map("document_version")
}

// ==============================
// Skill Primitive
// ==============================

model Skill {
    id           String  @id @default(cuid())
    slug         String  @unique
    name         String
    description  String? @db.Text
    instructions String  @db.Text
    examples     String? @db.Text

    category String?
    tags     String[]
    metadata Json?

    workspaceId String?
    workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

    version  Int            @default(1)
    versions SkillVersion[]

    documents SkillDocument[]
    tools     SkillTool[]
    agents    AgentSkill[]

    type      String   @default("USER")
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    createdBy String?

    @@index([workspaceId])
    @@index([category])
    @@map("skill")
}

model SkillVersion {
    id            String   @id @default(cuid())
    skillId       String
    skill         Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
    version       Int
    instructions  String   @db.Text
    configJson    Json?
    changeSummary String?
    createdAt     DateTime @default(now())
    createdBy     String?

    @@unique([skillId, version])
    @@map("skill_version")
}

model SkillDocument {
    id         String   @id @default(cuid())
    skillId    String
    skill      Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
    documentId String
    document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
    role       String?

    @@unique([skillId, documentId])
    @@map("skill_document")
}

model SkillTool {
    id      String @id @default(cuid())
    skillId String
    skill   Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)
    toolId  String

    @@unique([skillId, toolId])
    @@map("skill_tool")
}

model AgentSkill {
    id      String  @id @default(cuid())
    agentId String
    agent   Agent   @relation(fields: [agentId], references: [id], onDelete: Cascade)
    skillId String
    skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)
    pinned  Boolean @default(false) // true = always loaded at resolution, false = discoverable via meta-tools

    @@unique([agentId, skillId])
    @@map("agent_skill")
}

// Thread Skill State - Persists activated skills per conversation thread
// When an agent activates a skill via meta-tools during a conversation,
// the activation is stored here so subsequent turns in the same thread
// automatically load those skills without re-discovery.
model ThreadSkillState {
    id         String   @id @default(cuid())
    threadId   String   @unique
    agentId    String // Agent this state belongs to
    skillSlugs String[] // Activated skill slugs
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@index([threadId])
    @@index([agentId])
    @@map("thread_skill_state")
}

// ==============================
// Canvas Primitive
// ==============================

// Canvas - Agent-built, data-connected UI
model Canvas {
    id          String  @id @default(cuid())
    slug        String  @unique
    title       String
    description String? @db.Text

    // Schema definition (the full CanvasSchemaSpec JSON)
    schemaJson  Json
    dataQueries Json? // Extracted query definitions for server-side execution
    thumbnail   String? // Auto-generated preview URL

    // Status
    isPublished Boolean @default(false)
    isActive    Boolean @default(true)
    version     Int     @default(1)

    // Tenancy (same pattern as Workflow/Network)
    workspaceId String?
    workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    ownerId     String?
    createdBy   String?
    agentId     String? // Agent that created/maintains this canvas

    // Categorization
    tags     String[]
    category String?
    metadata Json?

    // Sharing
    isPublic    Boolean @default(false)
    publicToken String? @unique // Token for public access without auth

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    versions CanvasVersion[]

    @@index([slug])
    @@index([workspaceId])
    @@index([category])
    @@index([isPublished])
    @@map("canvas")
}

// Canvas Version History
model CanvasVersion {
    id         String   @id @default(cuid())
    canvasId   String
    canvas     Canvas   @relation(fields: [canvasId], references: [id], onDelete: Cascade)
    version    Int
    schemaJson Json
    changelog  String?  @db.Text
    createdAt  DateTime @default(now())
    createdBy  String?

    @@unique([canvasId, version])
    @@index([canvasId])
    @@map("canvas_version")
}

// ==============================
// Webhook Subscription Lifecycle
// ==============================

// WebhookSubscription - Tracks external push subscriptions (Graph, Dropbox, etc.)
model WebhookSubscription {
    id                      String                @id @default(cuid())
    integrationConnectionId String
    integrationConnection   IntegrationConnection @relation(fields: [integrationConnectionId], references: [id], onDelete: Cascade)
    providerKey             String // "microsoft-mail", "microsoft-calendar", "dropbox"
    externalSubscriptionId  String? // Graph subscription ID (null for Dropbox)
    resourcePath            String? // "/me/mailFolders('Inbox')/messages" etc
    clientState             String? // HMAC secret for Graph webhook verification
    notificationUrl         String? // Full webhook URL
    cursor                  String? // Dropbox delta cursor
    expiresAt               DateTime? // Graph subscription expiry (3-day max)
    lastRenewedAt           DateTime?
    errorCount              Int                   @default(0)
    errorMessage            String?               @db.Text
    isActive                Boolean               @default(true)
    metadata                Json?
    createdAt               DateTime              @default(now())
    updatedAt               DateTime              @updatedAt

    @@unique([integrationConnectionId, providerKey, resourcePath])
    @@index([providerKey, isActive])
    @@index([expiresAt])
    @@map("webhook_subscription")
}

// ==============================
// Calendar Event Primitive
// ==============================

// CalendarEvent - Normalized calendar events from Outlook/Google Calendar
model CalendarEvent {
    id                      String                 @id @default(cuid())
    organizationId          String
    integrationConnectionId String?
    integrationConnection   IntegrationConnection? @relation(fields: [integrationConnectionId], references: [id], onDelete: SetNull)
    externalEventId         String // Provider event ID (Graph event ID, Google event ID)
    calendarId              String? // Which calendar within the account
    subject                 String?
    bodyPreview             String?                @db.Text
    startAt                 DateTime?
    endAt                   DateTime?
    isAllDay                Boolean                @default(false)
    location                String?
    organizerEmail          String?
    attendeesJson           Json? // [{email, name, status}]
    recurrenceJson          Json? // Recurrence rule
    status                  String? // "confirmed", "tentative", "cancelled"
    sensitivity             String? // "normal", "personal", "private", "confidential"
    webLink                 String? // URL to open in browser
    metadata                Json?
    createdAt               DateTime               @default(now())
    updatedAt               DateTime               @updatedAt

    @@unique([integrationConnectionId, externalEventId])
    @@index([organizationId])
    @@index([startAt])
    @@map("calendar_event")
}

// SlackChannelPreference - Per-org/per-user channel routing for Slack agents
// Maps purpose keys (e.g., "support", "sales", "alerts") to Slack channel IDs.
// Linked to an IntegrationConnection (Slack installation) so each org has its own mappings.
model SlackChannelPreference {
    id                      String                @id @default(cuid())
    integrationConnectionId String
    integrationConnection   IntegrationConnection @relation(fields: [integrationConnectionId], references: [id], onDelete: Cascade)
    userId                  String? // Platform user ID (null = org-wide default)
    purposeKey              String // "support", "sales", "alerts", "general"
    channelId               String // Slack channel ID (C...)
    channelName             String? // Cached display name
    createdAt               DateTime              @default(now())
    updatedAt               DateTime              @updatedAt

    @@unique([integrationConnectionId, userId, purposeKey])
    @@index([integrationConnectionId])
    @@map("slack_channel_preference")
}

// SlackEventDedup - Prevents duplicate Slack event processing across multiple processes.
// Slack retries event delivery if it doesn't receive a timely 200. In a multi-process
// PM2 deployment, the in-memory dedup set is per-process. This table provides
// cross-process deduplication via a unique constraint on eventId.
model SlackEventDedup {
    eventId   String   @id
    expiresAt DateTime

    @@map("slack_event_dedup")
}
