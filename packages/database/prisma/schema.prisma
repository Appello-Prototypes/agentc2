// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Better Auth Models
model User {
    id            String    @id @default(cuid())
    name          String
    email         String    @unique
    emailVerified Boolean   @default(false)
    image         String?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    sessions      Session[]
    accounts      Account[]
    agents        Agent[]

    @@map("user")
}

model Session {
    id        String   @id @default(cuid())
    expiresAt DateTime
    token     String   @unique
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    ipAddress String?
    userAgent String?
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@map("session")
}

model Account {
    id                    String    @id @default(cuid())
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    @@index([userId])
    @@map("account")
}

model Verification {
    id         String    @id @default(cuid())
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime? @default(now())
    updatedAt  DateTime? @updatedAt

    @@map("verification")
}

// ==============================
// Multi-Tenant Organization Models
// ==============================

// Organization - Company or team boundary for multi-tenancy
model Organization {
    id          String   @id @default(cuid())
    name        String
    slug        String   @unique // URL-safe identifier
    description String?
    logoUrl     String?
    metadata    Json?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // Relations
    workspaces  Workspace[]
    memberships Membership[]
    credentials ToolCredential[]

    @@index([slug])
    @@map("organization")
}

// Workspace - Environment within an org (dev/staging/prod)
model Workspace {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    name           String
    slug           String // URL-safe identifier within org
    environment    String       @default("development") // "development", "staging", "production"
    description    String?
    isDefault      Boolean      @default(false)
    metadata       Json?
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt

    // Relations
    agents    Agent[]
    schedules AgentSchedule[]
    triggers  AgentTrigger[]

    @@unique([organizationId, slug])
    @@index([organizationId])
    @@map("workspace")
}

// Membership - User's role in an organization
model Membership {
    id             String       @id @default(cuid())
    userId         String
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    role           String       @default("member") // "owner", "admin", "member", "viewer"
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt

    @@unique([userId, organizationId])
    @@index([userId])
    @@index([organizationId])
    @@map("membership")
}

// ToolCredential - Scoped credentials for MCP/tool access per organization
model ToolCredential {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    toolId         String // MCP server or tool key (e.g., "hubspot", "jira")
    name           String
    credentials    Json // Encrypted credentials
    isActive       Boolean      @default(true)
    lastUsedAt     DateTime?
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt
    createdBy      String?

    @@unique([organizationId, toolId])
    @@index([organizationId])
    @@map("tool_credential")
}

// Agent Type Enum
enum AgentType {
    SYSTEM // Seeded from code, protected from deletion
    USER // User-created, fully editable
}

// Run Status Enum
enum RunStatus {
    QUEUED
    RUNNING
    COMPLETED
    FAILED
    CANCELLED
}

// Run Type Enum
enum RunType {
    TEST
    PROD
    AB
}

// Alert Severity Enum
enum AlertSeverity {
    INFO
    WARNING
    CRITICAL
}

// Alert Source Enum
enum AlertSource {
    COST
    GUARDRAIL
    EVAL
    SYSTEM
}

// Guardrail Event Type Enum
enum GuardrailEventType {
    BLOCKED
    MODIFIED
    FLAGGED
}

// Agents - Database-backed agent configurations (Mastra-aligned)
model Agent {
    id          String  @id @default(cuid())
    slug        String  @unique // URL-safe identifier
    name        String
    description String?

    // Instructions - static or templated
    instructions         String  @db.Text
    instructionsTemplate String? @db.Text // Template with {{userId}}, {{userName}}, etc.

    // Model configuration
    modelProvider String // "openai", "anthropic", "google"
    modelName     String // "gpt-4o", "claude-sonnet-4-20250514"
    temperature   Float? @default(0.7)
    maxTokens     Int?
    modelConfig   Json? // Provider-specific: {reasoning: {type: "enabled"}, toolChoice: "auto"}

    // Tool configuration (junction table)
    tools AgentTool[]

    // Memory configuration (Mastra Memory pattern)
    memoryEnabled Boolean @default(false)
    memoryConfig  Json? // {lastMessages, semanticRecall, workingMemory}

    // Multi-step workflows
    maxSteps Int? @default(5)

    // Evaluation configuration
    scorers String[] @default([])

    // Permissions/tenancy
    type        AgentType  @default(USER)
    tenantId    String? // Multi-tenant isolation (legacy, use workspaceId)
    workspaceId String?
    workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    ownerId     String?
    owner       User?      @relation(fields: [ownerId], references: [id])
    isPublic    Boolean    @default(false)

    // Policies
    requiresApproval Boolean @default(false) // Require human approval for runs
    maxSpendUsd      Float? // Max spend per run in USD

    // Metadata
    metadata Json?
    isActive Boolean @default(true)
    version  Int     @default(1)

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    createdBy String?

    // Relations
    versions               AgentVersion[]
    runs                   AgentRun[]
    traces                 AgentTrace[]
    alerts                 AgentAlert[]
    evaluations            AgentEvaluation[]
    feedback               AgentFeedback[]
    testCases              AgentTestCase[]
    testRuns               AgentTestRun[]
    conversations          AgentConversation[]
    budgetPolicy           BudgetPolicy?
    costEvents             CostEvent[]
    costDaily              AgentCostDaily[]
    modelCostDaily         AgentModelCostDaily[]
    costRecommendations    CostRecommendation[]
    guardrailPolicy        GuardrailPolicy?
    guardrailEvents        GuardrailEvent[]
    statsDaily             AgentStatsDaily[]
    metricDaily            AgentMetricDaily[]
    toolMetricDaily        AgentToolMetricDaily[]
    modelMetricDaily       AgentModelMetricDaily[]
    qualityMetricDaily     AgentQualityMetricDaily[]
    feedbackAggregateDaily AgentFeedbackAggregateDaily[]
    versionStats           AgentVersionStats[]
    themes                 EvaluationTheme[]
    insights               Insight[]
    learningSessions       LearningSession[]
    learningMetricDaily    LearningMetricDaily[]
    learningPolicy         LearningPolicy?
    simulationSessions     SimulationSession[]
    schedules              AgentSchedule[]
    triggers               AgentTrigger[]

    @@index([slug])
    @@index([workspaceId])
    @@index([ownerId])
    @@index([tenantId])
    @@index([type])
    @@map("agent")
}

// Agent-Tool Junction Table
model AgentTool {
    id      String @id @default(cuid())
    agentId String
    agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
    toolId  String // Tool registry key (e.g., "calculator", "web-fetch")
    config  Json? // Tool-specific: {inputSchema, outputSchema, description override}

    @@unique([agentId, toolId])
    @@map("agent_tool")
}

// Agent Version History
model AgentVersion {
    id            String   @id @default(cuid())
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    version       Int
    description   String?  @db.Text
    instructions  String   @db.Text
    modelProvider String
    modelName     String
    changesJson   Json? // Description of changes from previous version
    snapshot      Json // Full agent config + tool IDs + scorer IDs at this version
    createdAt     DateTime @default(now())
    createdBy     String?

    // Relations
    versionStats AgentVersionStats[]

    @@unique([agentId, version])
    @@index([agentId, version])
    @@map("agent_version")
}

// Agent Schedule - Cron-based recurring execution
model AgentSchedule {
    id          String     @id @default(cuid())
    agentId     String
    agent       Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)
    workspaceId String?
    workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    name        String
    description String?
    cronExpr    String // Cron expression (e.g., "0 17 * * FRI")
    timezone    String     @default("UTC")
    inputJson   Json? // Default input for scheduled runs
    isActive    Boolean    @default(true)
    lastRunAt   DateTime?
    nextRunAt   DateTime?
    runCount    Int        @default(0)
    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @updatedAt
    createdBy   String?

    @@index([agentId])
    @@index([workspaceId])
    @@index([isActive, nextRunAt])
    @@map("agent_schedule")
}

// Agent Trigger - Event-based invocation
model AgentTrigger {
    id              String     @id @default(cuid())
    agentId         String
    agent           Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)
    workspaceId     String?
    workspace       Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
    name            String
    description     String?
    triggerType     String // "webhook", "event", "mcp"
    eventName       String? // Event name to listen for
    webhookPath     String? // Unique webhook path for this trigger
    webhookSecret   String? // Secret for webhook validation
    filterJson      Json? // Conditions to match before triggering
    inputMapping    Json? // How to map trigger payload to agent input
    isActive        Boolean    @default(true)
    lastTriggeredAt DateTime?
    triggerCount    Int        @default(0)
    createdAt       DateTime   @default(now())
    updatedAt       DateTime   @updatedAt
    createdBy       String?

    @@unique([webhookPath])
    @@index([agentId])
    @@index([workspaceId])
    @@index([triggerType])
    @@index([eventName])
    @@map("agent_trigger")
}

// Legacy Stored Agents - Kept for backwards compatibility during migration
model StoredAgent {
    id            String   @id @default(cuid())
    name          String
    description   String?
    instructions  String   @db.Text
    modelProvider String // "openai", "anthropic", etc.
    modelName     String // "gpt-4o", "claude-sonnet", etc.
    temperature   Float?   @default(0.7)
    tools         String[] // Tool names to attach
    memory        Boolean  @default(false)
    metadata      Json?
    isActive      Boolean  @default(true)
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    @@map("stored_agent")
}

// ==============================
// Channel System Models
// ==============================

// Channel Session - Tracks conversations per channel/user
model ChannelSession {
    id         String   @id @default(cuid())
    channel    String // "whatsapp" | "telegram" | "voice"
    channelId  String // Phone number, chat ID, or call SID
    agentSlug  String // Which agent handles this conversation
    metadata   Json? // Channel-specific data (e.g., username, group info)
    lastActive DateTime @default(now())
    createdAt  DateTime @default(now())

    @@unique([channel, channelId])
    @@index([channel])
    @@index([agentSlug])
    @@map("channel_session")
}

// Channel Credentials - Stores encrypted credentials for each channel
model ChannelCredentials {
    id          String   @id @default(cuid())
    channel     String   @unique // "whatsapp" | "telegram" | "voice"
    credentials Json // Encrypted credentials (WhatsApp session, bot tokens, etc.)
    isActive    Boolean  @default(true)
    updatedAt   DateTime @updatedAt

    @@map("channel_credentials")
}

// Voice Call Log - Tracks voice call history
model VoiceCallLog {
    id           String    @id @default(cuid())
    callSid      String    @unique // Twilio call SID
    direction    String // "inbound" | "outbound"
    fromNumber   String
    toNumber     String
    agentSlug    String?
    status       String // "ringing" | "in-progress" | "completed" | "failed" | "busy" | "no-answer"
    duration     Int? // Duration in seconds
    recordingUrl String?
    transcript   String?   @db.Text
    metadata     Json?
    startedAt    DateTime  @default(now())
    endedAt      DateTime?
    createdAt    DateTime  @default(now())

    @@index([fromNumber])
    @@index([toNumber])
    @@index([agentSlug])
    @@map("voice_call_log")
}

// Voice Agent Trace - Full observability for voice agent conversations
model VoiceAgentTrace {
    id        String   @id @default(cuid())
    traceId   String   @unique // External trace ID
    timestamp DateTime @default(now())

    // Conversation content
    input  String @db.Text // User's question
    output String @db.Text // Agent's response

    // Model configuration
    model Json // {provider, name, temperature}

    // Tools
    availableTools String[] // Tool names available to agent
    toolCalls      Json // Array of {name, input, output, success, error, durationMs}

    // Execution trace
    steps Json // Array of {step, type, content, timestamp, toolCall?}

    // Performance
    durationMs Int
    tokens     Json? // {prompt, completion, total}

    // Evaluation scores
    scores Json // {helpfulness?: {score, reasoning}, relevancy?: {score}}

    // Metadata
    metadata Json // {source, agentSlug, agentSource, elevenlabsAgentId, maxSteps}

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([timestamp])
    @@index([createdAt])
    @@map("voice_agent_trace")
}

// ==============================
// Agent Workspace Models
// ==============================

// Agent Run - Execution history
model AgentRun {
    id               String    @id @default(cuid())
    agentId          String
    agent            Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId         String?
    runType          RunType   @default(PROD)
    status           RunStatus @default(QUEUED)
    inputText        String    @db.Text
    outputText       String?   @db.Text
    durationMs       Int?
    startedAt        DateTime  @default(now())
    completedAt      DateTime?
    modelProvider    String?
    modelName        String?
    versionId        String?
    promptTokens     Int?
    completionTokens Int?
    totalTokens      Int?
    costUsd          Float?
    userId           String?
    createdAt        DateTime  @default(now())

    // Continuous Learning: Experiment linkage for shadow A/B testing
    experimentId    String? // Links run to active experiment for A/B testing
    experiment      LearningExperiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)
    experimentGroup String? // "baseline" or "candidate" - which version this run used

    // Production channel tracking
    source    String? // "slack", "whatsapp", "voice", "telegram", "elevenlabs", "api", "test"
    sessionId String? // Channel session ID for conversation grouping
    threadId  String? // Thread/conversation ID within a channel

    // Relations
    trace           AgentTrace?
    toolCalls       AgentToolCall[]
    evaluation      AgentEvaluation?
    feedback        AgentFeedback?
    costEvent       CostEvent?
    guardrailEvents GuardrailEvent[]
    conversation    AgentConversation?
    testRun         AgentTestRun?

    @@index([agentId, createdAt])
    @@index([status])
    @@index([tenantId])
    @@index([experimentId])
    @@index([source])
    @@index([sessionId])
    @@index([threadId])
    @@map("agent_run")
}

// Agent Trace - Detailed execution trace per run
model AgentTrace {
    id         String    @id @default(cuid())
    runId      String    @unique
    run        AgentRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
    agentId    String
    agent      Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId   String?
    status     RunStatus @default(RUNNING)
    inputText  String    @db.Text
    outputText String?   @db.Text
    durationMs Int?
    stepsJson  Json? // Array of execution steps
    modelJson  Json? // Model configuration used
    tokensJson Json? // Token counts
    scoresJson Json? // Evaluation scores
    createdAt  DateTime  @default(now())

    // Relations
    steps     AgentTraceStep[]
    toolCalls AgentToolCall[]

    @@index([runId])
    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("agent_trace")
}

// Agent Trace Step - Individual execution steps
model AgentTraceStep {
    id         String     @id @default(cuid())
    traceId    String
    trace      AgentTrace @relation(fields: [traceId], references: [id], onDelete: Cascade)
    tenantId   String?
    stepNumber Int
    type       String // "llm" | "tool" | "memory" | "guardrail"
    content    Json // Step-specific content
    timestamp  DateTime   @default(now())
    durationMs Int?

    @@index([traceId, stepNumber])
    @@index([tenantId])
    @@map("agent_trace_step")
}

// Agent Tool Call - Tool call records
model AgentToolCall {
    id          String      @id @default(cuid())
    runId       String?
    run         AgentRun?   @relation(fields: [runId], references: [id], onDelete: Cascade)
    traceId     String?
    trace       AgentTrace? @relation(fields: [traceId], references: [id], onDelete: Cascade)
    tenantId    String?
    toolKey     String
    mcpServerId String?
    inputJson   Json?
    outputJson  Json?
    success     Boolean     @default(true)
    error       String?     @db.Text
    durationMs  Int?
    createdAt   DateTime    @default(now())

    @@index([runId])
    @@index([traceId, toolKey])
    @@index([tenantId])
    @@map("agent_tool_call")
}

// Agent Alert - System/budget/guardrail alerts
model AgentAlert {
    id         String        @id @default(cuid())
    agentId    String
    agent      Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId   String?
    severity   AlertSeverity @default(INFO)
    message    String        @db.Text
    source     AlertSource   @default(SYSTEM)
    createdAt  DateTime      @default(now())
    resolvedAt DateTime?

    @@index([agentId, createdAt, severity])
    @@index([tenantId])
    @@map("agent_alert")
}

// Audit Log - All write operations
model AuditLog {
    id         String   @id @default(cuid())
    tenantId   String?
    actorId    String? // User ID who performed the action
    action     String // AGENT_CREATE, AGENT_UPDATE, CONFIG_CHANGE, etc.
    entityType String // Agent, AgentVersion, etc.
    entityId   String
    metadata   Json? // Additional context
    createdAt  DateTime @default(now())

    @@index([tenantId, createdAt])
    @@index([entityId])
    @@map("audit_log")
}

// Agent Evaluation - Evaluation scores per run
model AgentEvaluation {
    id            String   @id @default(cuid())
    runId         String   @unique
    run           AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    scoresJson    Json // {relevancy: 0.9, toxicity: 0.1, ...}
    scorerVersion String?
    createdAt     DateTime @default(now())

    @@index([runId])
    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("agent_evaluation")
}

// Agent Feedback - User feedback per run
model AgentFeedback {
    id        String   @id @default(cuid())
    runId     String   @unique
    run       AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
    agentId   String
    agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId  String?
    thumbs    Boolean? // true = up, false = down
    rating    Int? // 1-5 scale
    comment   String?  @db.Text
    createdAt DateTime @default(now())

    @@index([runId])
    @@index([agentId])
    @@index([tenantId])
    @@map("agent_feedback")
}

// Agent Test Case - Stored test cases
model AgentTestCase {
    id             String   @id @default(cuid())
    agentId        String
    agent          Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId       String?
    name           String
    inputText      String   @db.Text
    expectedOutput String?  @db.Text
    tags           String[] @default([])
    createdBy      String?
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    // Relations
    testRuns AgentTestRun[]

    @@index([agentId])
    @@index([tenantId])
    @@map("agent_test_case")
}

// Agent Test Run - Test execution results
model AgentTestRun {
    id         String        @id @default(cuid())
    testCaseId String
    testCase   AgentTestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
    agentId    String
    agent      Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId   String?
    versionId  String?
    runId      String?       @unique
    run        AgentRun?     @relation(fields: [runId], references: [id], onDelete: SetNull)
    outputText String?       @db.Text
    passed     Boolean?
    score      Float?
    durationMs Int?
    tokens     Int?
    createdAt  DateTime      @default(now())

    @@index([testCaseId])
    @@index([agentId])
    @@index([tenantId])
    @@map("agent_test_run")
}

// Agent Conversation - Multi-turn conversation persistence
model AgentConversation {
    id           String    @id @default(cuid())
    agentId      String
    agent        Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId     String?
    runId        String?   @unique
    run          AgentRun? @relation(fields: [runId], references: [id], onDelete: SetNull)
    messagesJson Json // Array of {role, content, timestamp}
    createdAt    DateTime  @default(now())

    @@index([agentId])
    @@index([tenantId])
    @@map("agent_conversation")
}

// Budget Policy - Per-agent budget settings
model BudgetPolicy {
    id              String   @id @default(cuid())
    agentId         String   @unique
    agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId        String?
    enabled         Boolean  @default(false)
    monthlyLimitUsd Float?
    alertAtPct      Float?   @default(80) // Alert when usage reaches this percentage
    hardLimit       Boolean  @default(false) // Block runs when limit exceeded
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    @@index([agentId])
    @@index([tenantId])
    @@map("budget_policy")
}

// Cost Event - Token/cost tracking per run
model CostEvent {
    id               String   @id @default(cuid())
    runId            String   @unique
    run              AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
    agentId          String
    agent            Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId         String?
    provider         String
    modelName        String
    promptTokens     Int?
    completionTokens Int?
    totalTokens      Int?
    costUsd          Float?
    createdAt        DateTime @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("cost_event")
}

// Agent Cost Daily - Daily cost rollups
model AgentCostDaily {
    id                String   @id @default(cuid())
    agentId           String
    agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId          String?
    date              DateTime @db.Date
    totalCostUsd      Float    @default(0)
    promptCostUsd     Float    @default(0)
    completionCostUsd Float    @default(0)
    runs              Int      @default(0)

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("agent_cost_daily")
}

// Agent Model Cost Daily - Cost by model per day
model AgentModelCostDaily {
    id        String   @id @default(cuid())
    agentId   String
    agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId  String?
    modelName String
    date      DateTime @db.Date
    costUsd   Float    @default(0)
    tokens    Int      @default(0)
    runs      Int      @default(0)

    @@unique([agentId, modelName, date])
    @@index([agentId, modelName, date])
    @@index([tenantId])
    @@map("agent_model_cost_daily")
}

// Cost Recommendation - AI-generated savings tips
model CostRecommendation {
    id                  String   @id @default(cuid())
    agentId             String
    agent               Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId            String?
    type                String // "model_switch", "prompt_optimization", etc.
    title               String
    description         String   @db.Text
    estimatedSavingsUsd Float?
    createdAt           DateTime @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("cost_recommendation")
}

// Guardrail Policy - Per-agent guardrail config
model GuardrailPolicy {
    id         String   @id @default(cuid())
    agentId    String   @unique
    agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId   String?
    configJson Json // Full guardrail configuration
    version    Int      @default(1)
    createdBy  String?
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@index([agentId])
    @@index([tenantId])
    @@map("guardrail_policy")
}

// Guardrail Event - Blocked/modified/flagged events
model GuardrailEvent {
    id            String             @id @default(cuid())
    agentId       String
    agent         Agent              @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    runId         String?
    run           AgentRun?          @relation(fields: [runId], references: [id], onDelete: SetNull)
    type          GuardrailEventType
    guardrailKey  String
    reason        String             @db.Text
    inputSnippet  String?            @db.Text
    outputSnippet String?            @db.Text
    createdAt     DateTime           @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("guardrail_event")
}

// Agent Stats Daily - Daily KPI rollups
model AgentStatsDaily {
    id              String   @id @default(cuid())
    agentId         String
    agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId        String?
    date            DateTime @db.Date
    totalRuns       Int      @default(0)
    successRate     Float?
    avgDurationMs   Float?
    avgQualityScore Float?
    totalCostUsd    Float    @default(0)

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("agent_stats_daily")
}

// Agent Metric Daily - Performance metrics
model AgentMetricDaily {
    id           String   @id @default(cuid())
    agentId      String
    agent        Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId     String?
    date         DateTime @db.Date
    runs         Int      @default(0)
    successRate  Float?
    avgLatencyMs Float?
    errorRate    Float?
    qualityScore Float?

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("agent_metric_daily")
}

// Agent Tool Metric Daily - Tool usage metrics
model AgentToolMetricDaily {
    id            String   @id @default(cuid())
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    toolKey       String
    date          DateTime @db.Date
    callCount     Int      @default(0)
    successRate   Float?
    avgDurationMs Float?

    @@unique([agentId, toolKey, date])
    @@index([agentId, toolKey, date])
    @@index([tenantId])
    @@map("agent_tool_metric_daily")
}

// Agent Model Metric Daily - Model comparison metrics
model AgentModelMetricDaily {
    id            String   @id @default(cuid())
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    modelProvider String
    modelName     String
    date          DateTime @db.Date
    runs          Int      @default(0)
    avgLatencyMs  Float?
    qualityScore  Float?
    costUsd       Float    @default(0)

    @@unique([agentId, modelName, date])
    @@index([agentId, modelName, date])
    @@index([tenantId])
    @@map("agent_model_metric_daily")
}

// Agent Quality Metric Daily - Quality score rollups
model AgentQualityMetricDaily {
    id          String   @id @default(cuid())
    agentId     String
    agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId    String?
    scorerKey   String
    date        DateTime @db.Date
    avgScore    Float?
    sampleCount Int      @default(0)

    @@unique([agentId, scorerKey, date])
    @@index([agentId, scorerKey, date])
    @@index([tenantId])
    @@map("agent_quality_metric_daily")
}

// Agent Feedback Aggregate Daily - Feedback summaries
model AgentFeedbackAggregateDaily {
    id            String   @id @default(cuid())
    agentId       String
    agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId      String?
    date          DateTime @db.Date
    positiveCount Int      @default(0)
    negativeCount Int      @default(0)

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("agent_feedback_aggregate_daily")
}

// Agent Version Stats - Per-version performance
model AgentVersionStats {
    id          String       @id @default(cuid())
    versionId   String
    version     AgentVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
    agentId     String
    agent       Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId    String?
    runs        Int          @default(0)
    successRate Float?
    avgQuality  Float?
    updatedAt   DateTime     @updatedAt

    @@unique([versionId])
    @@index([versionId])
    @@index([tenantId])
    @@map("agent_version_stats")
}

// Evaluation Theme - Feedback theme extraction
model EvaluationTheme {
    id        String   @id @default(cuid())
    agentId   String
    agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId  String?
    theme     String
    sentiment String? // "positive", "negative", "neutral"
    count     Int      @default(0)
    createdAt DateTime @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("evaluation_theme")
}

// Insight - AI-generated insights
model Insight {
    id          String   @id @default(cuid())
    agentId     String
    agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId    String?
    type        String // "performance", "cost", "quality", etc.
    title       String
    description String   @db.Text
    createdAt   DateTime @default(now())

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@map("insight")
}

// ==============================
// Closed-Loop Learning Models
// ==============================

// Learning Session Status Enum
enum LearningSessionStatus {
    COLLECTING // Gathering runs for analysis
    ANALYZING // Extracting signals from runs
    PROPOSING // Generating improvement proposals
    TESTING // Running A/B experiments
    AWAITING_APPROVAL // Waiting for human approval
    APPROVED // Approved and promoting
    REJECTED // Rejected by human
    PROMOTED // Successfully promoted new version
    FAILED // Failed during processing
}

// Learning Experiment Status Enum
enum LearningExperimentStatus {
    PENDING // Not started
    RUNNING // A/B test in progress
    COMPLETED // Test finished
    PASSED // Candidate beat baseline
    FAILED // Candidate did not beat baseline
}

// Learning Signal Type Enum
enum LearningSignalType {
    LOW_SCORE // Run scored below threshold
    TOOL_FAILURE // Tool call failed
    GUARDRAIL_HIT // Guardrail triggered
    NEGATIVE_FEEDBACK // User gave negative feedback
    HIGH_LATENCY // Run took too long
    ERROR // Run failed with error
    PATTERN // Detected pattern across runs
}

// Risk Tier Enum for Continuous Learning
enum RiskTier {
    LOW // Safe for auto-promotion (instruction-only edits)
    MEDIUM // Requires review but not high-risk
    HIGH // Requires human approval (model/tool/memory changes)
}

// Learning Session - Orchestrates each closed-loop learning cycle
model LearningSession {
    id              String                @id @default(cuid())
    agentId         String
    agent           Agent                 @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId        String?
    status          LearningSessionStatus @default(COLLECTING)
    runCount        Int                   @default(0) // Number of runs analyzed
    datasetHash     String? // SHA256 hash of run IDs for provenance
    baselineVersion Int? // Agent version at start
    scorerConfig    Json? // Scorer configuration used
    thresholdsJson  Json? // Gating thresholds for A/B test
    metadata        Json? // Additional context
    createdBy       String?
    createdAt       DateTime              @default(now())
    updatedAt       DateTime              @updatedAt
    completedAt     DateTime?

    // Relations
    dataset     LearningDataset?
    signals     LearningSignal[]
    proposals   LearningProposal[]
    experiments LearningExperiment[]
    approval    LearningApproval?

    @@index([agentId, createdAt])
    @@index([tenantId])
    @@index([status])
    @@map("learning_session")
}

// Learning Dataset - Snapshot of runs used for learning
model LearningDataset {
    id                String          @id @default(cuid())
    sessionId         String          @unique
    session           LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    tenantId          String?
    runIds            String[] // Array of AgentRun IDs included
    selectionCriteria Json? // Criteria used to select runs
    datasetHash       String // SHA256 hash for reproducibility
    fromDate          DateTime? // Start of time range
    toDate            DateTime? // End of time range
    runCount          Int             @default(0)
    avgScore          Float? // Average quality score
    createdAt         DateTime        @default(now())

    @@index([sessionId])
    @@index([tenantId])
    @@index([datasetHash])
    @@map("learning_dataset")
}

// Learning Signal - Extracted patterns from runs
model LearningSignal {
    id           String             @id @default(cuid())
    sessionId    String
    session      LearningSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    tenantId     String?
    type         LearningSignalType
    severity     String? // "low", "medium", "high"
    pattern      String             @db.Text // Description of the pattern
    evidenceJson Json? // Run IDs and specific examples
    frequency    Int                @default(1) // How often this occurred
    impact       Float? // Estimated impact score
    createdAt    DateTime           @default(now())

    @@index([sessionId])
    @@index([tenantId])
    @@index([type])
    @@map("learning_signal")
}

// Learning Proposal - Proposed changes to improve agent
model LearningProposal {
    id                 String          @id @default(cuid())
    sessionId          String
    session            LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    tenantId           String?
    proposalType       String // "instructions", "tools", "memory", "model", "combined"
    title              String
    description        String          @db.Text
    instructionsDiff   String?         @db.Text // Unified diff of instructions change
    toolChangesJson    Json? // {added: [], removed: [], modified: []}
    memoryChangesJson  Json? // Changes to memory config
    modelChangesJson   Json? // Changes to model config
    expectedImpact     String?         @db.Text // Expected improvement
    confidenceScore    Float? // 0-1 confidence in proposal
    generatedBy        String? // "llm", "heuristic", "human"
    candidateVersionId String? // Created AgentVersion ID if built
    isSelected         Boolean         @default(false) // Selected for testing
    createdAt          DateTime        @default(now())

    // Continuous Learning: Risk assessment fields
    riskTier     RiskTier? // LOW, MEDIUM, HIGH - determines auto-promotion eligibility
    autoEligible Boolean   @default(false) // Whether this can be auto-promoted
    riskReasons  Json? // Array of reasons for risk classification

    // Relations
    experiments LearningExperiment[]

    @@index([sessionId])
    @@index([tenantId])
    @@index([riskTier])
    @@map("learning_proposal")
}

// Learning Experiment - A/B test configuration and results
model LearningExperiment {
    id                 String                   @id @default(cuid())
    sessionId          String
    session            LearningSession          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    proposalId         String
    proposal           LearningProposal         @relation(fields: [proposalId], references: [id], onDelete: Cascade)
    tenantId           String?
    status             LearningExperimentStatus @default(PENDING)
    baselineVersionId  String? // Current agent version
    candidateVersionId String? // New version to test
    testCaseIds        String[] // Test cases used
    syntheticTestCount Int                      @default(0) // Generated test count
    baselineMetrics    Json? // {avgScore, successRate, latency, etc.}
    candidateMetrics   Json? // Same structure as baseline
    gatingThreshold    Float                    @default(0.5) // Win rate needed
    winRate            Float? // Candidate win rate
    confidenceInterval Json? // {lower, upper}
    gatingResult       String? // "passed", "failed", "inconclusive"
    startedAt          DateTime?
    completedAt        DateTime?
    createdAt          DateTime                 @default(now())

    // Continuous Learning: Real-traffic shadow testing fields
    trafficSplit      Json? // {baseline: 0.9, candidate: 0.1} - traffic allocation
    shadowRunCount    Int   @default(0) // Total runs in shadow test
    baselineRunCount  Int   @default(0) // Runs routed to baseline
    candidateRunCount Int   @default(0) // Runs routed to candidate

    // Relations
    runs AgentRun[] // Runs tagged to this experiment

    @@index([sessionId])
    @@index([proposalId])
    @@index([tenantId])
    @@index([status])
    @@map("learning_experiment")
}

// Learning Approval - Human or auto decision on proposals
model LearningApproval {
    id                String          @id @default(cuid())
    sessionId         String          @unique
    session           LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    tenantId          String?
    decision          String // "approved", "rejected", "deferred", "auto_approved"
    rationale         String?         @db.Text
    approvedBy        String? // User ID (null for auto-approval)
    promotedVersionId String? // New AgentVersion ID if promoted
    reviewedAt        DateTime?
    createdAt         DateTime        @default(now())

    // Continuous Learning: Auto-promotion tracking
    autoApproved Boolean @default(false) // Whether this was auto-approved

    @@index([sessionId])
    @@index([tenantId])
    @@index([autoApproved])
    @@map("learning_approval")
}

// Learning Policy - Per-agent continuous learning configuration
model LearningPolicy {
    id                   String    @id @default(cuid())
    agentId              String    @unique
    agent                Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId             String?
    enabled              Boolean   @default(true) // Master switch for continuous learning
    autoPromotionEnabled Boolean   @default(false) // Allow auto-promotion for low-risk changes
    scheduledEnabled     Boolean   @default(true) // Enable scheduled backstop triggers
    thresholdEnabled     Boolean   @default(true) // Enable signal threshold triggers
    paused               Boolean   @default(false) // Temporarily pause learning
    pausedUntil          DateTime? // Auto-resume after this time

    // Thresholds and configuration (can override global defaults)
    signalThreshold       Int? // Signals needed to trigger session
    signalWindowMinutes   Int? // Time window for signal accumulation
    trafficSplitCandidate Float? // Default candidate traffic split (e.g., 0.1 = 10%)
    minConfidenceForAuto  Float? // Minimum confidence score for auto-promotion
    minWinRateForAuto     Float? // Minimum win rate for auto-promotion

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    updatedBy String?

    @@index([agentId])
    @@index([tenantId])
    @@map("learning_policy")
}

// Learning Metric Daily - Daily closed-loop learning KPIs
model LearningMetricDaily {
    id                 String   @id @default(cuid())
    agentId            String
    agent              Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
    tenantId           String?
    date               DateTime @db.Date
    sessionsStarted    Int      @default(0)
    sessionsCompleted  Int      @default(0)
    proposalsGenerated Int      @default(0)
    proposalsApproved  Int      @default(0)
    proposalsRejected  Int      @default(0)
    experimentsRun     Int      @default(0)
    experimentsPassed  Int      @default(0)
    versionsPromoted   Int      @default(0)
    avgImprovementPct  Float? // Average quality improvement
    evalCoverage       Float? // Percentage of runs evaluated

    // Continuous Learning: Auto vs Manual tracking
    autoPromotions    Int @default(0) // Promotions via auto-approval
    manualPromotions  Int @default(0) // Promotions via human approval
    shadowRunCount    Int @default(0) // Runs in shadow A/B tests
    baselineRunCount  Int @default(0) // Runs routed to baseline
    candidateRunCount Int @default(0) // Runs routed to candidate
    regressionCount   Int @default(0) // Guardrail regressions detected
    scheduledTriggers Int @default(0) // Sessions started via schedule
    thresholdTriggers Int @default(0) // Sessions started via signal threshold

    @@unique([agentId, date])
    @@index([agentId, date])
    @@index([tenantId])
    @@map("learning_metric_daily")
}

// ==============================
// Simulation System Models
// ==============================

// Simulation Session - Tracks a batch of simulated conversations for testing agents
model SimulationSession {
    id      String @id @default(cuid())
    agentId String
    agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
    theme   String @db.Text // "Customer service about timesheets"
    status  String @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, CANCELLED

    // Configuration
    targetCount Int @default(100)
    concurrency Int @default(5)

    // Progress
    completedCount Int @default(0)
    failedCount    Int @default(0)

    // Results (computed when complete)
    avgQualityScore Float?
    avgDurationMs   Float?
    successRate     Float?
    totalCostUsd    Float?

    // Timing
    startedAt   DateTime?
    completedAt DateTime?
    createdAt   DateTime  @default(now())

    @@index([agentId, createdAt])
    @@index([status])
    @@map("simulation_session")
}
