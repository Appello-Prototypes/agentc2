---
title: "Authentication"
description: "Better Auth session management, cross-app cookie sharing via Caddy, role-based access control, and authentication middleware."
section: "platform"
order: 2
primaryKeyword: "authentication"
relatedSlugs: ["platform/multi-tenancy", "platform/security", "platform/deployment"]
pageType: "reference"
ctaLabel: "Launch AgentC2 Workspace"
ctaHref: "/workspace"
---

# Authentication

AgentC2 uses Better Auth for session-based authentication with PostgreSQL storage, cross-app cookie sharing via Caddy reverse proxy, and role-based access control. Sessions are managed server-side with secure HTTP-only cookies, enabling seamless authentication across frontend and agent applications.

## Better Auth setup

Better Auth is configured with PostgreSQL adapter, email/password authentication, and optional social providers (Google, Microsoft):

```typescript
// packages/auth/src/auth.ts
export const auth = betterAuth({
    database: prismaAdapter(prisma, {
        provider: "postgresql"
    }),
    emailAndPassword: {
        enabled: true,
        requireEmailVerification: isProduction
    },
    socialProviders: {
        google: {
            /* ... */
        },
        microsoft: {
            /* ... */
        }
    },
    session: {
        expiresIn: 60 * 60 * 24, // 24 hours
        updateAge: 60 * 60 * 6, // Update every 6 hours
        cookieCache: {
            enabled: true,
            maxAge: 60 * 5 // 5 minutes
        }
    },
    secret: process.env.BETTER_AUTH_SECRET!,
    baseURL: process.env.NEXT_PUBLIC_APP_URL
});
```

### Environment variables

| Variable                  | Description                             | Example                                              |
| ------------------------- | --------------------------------------- | ---------------------------------------------------- |
| `BETTER_AUTH_SECRET`      | Encryption key for sessions (32+ bytes) | Generated via `openssl rand -base64 32`              |
| `NEXT_PUBLIC_APP_URL`     | Base URL for auth callbacks             | `https://agentc2.ai` or `https://catalyst.localhost` |
| `GOOGLE_CLIENT_ID`        | Google OAuth client ID                  | _(optional)_                                         |
| `GOOGLE_CLIENT_SECRET`    | Google OAuth client secret              | _(optional)_                                         |
| `MICROSOFT_CLIENT_ID`     | Microsoft OAuth client ID               | _(optional)_                                         |
| `MICROSOFT_CLIENT_SECRET` | Microsoft OAuth client secret           | _(optional)_                                         |

<Callout type="warning">
    **Generate secure secrets**: Always use cryptographically secure random values for
    `BETTER_AUTH_SECRET`. Never commit secrets to version control.
</Callout>

## Session management

Sessions are stored in PostgreSQL and managed via HTTP-only cookies:

### Session lifecycle

1. **Login** — User authenticates via email/password or OAuth
2. **Session creation** — Better Auth creates session record in database
3. **Cookie set** — HTTP-only cookie set on `NEXT_PUBLIC_APP_URL` domain
4. **Session validation** — Middleware validates session on each request
5. **Session refresh** — Cookie updated every 6 hours (`updateAge`)
6. **Session expiration** — Session expires after 24 hours (`expiresIn`)

### Session configuration

```typescript
session: {
  expiresIn: 60 * 60 * 24,      // 24 hours
  updateAge: 60 * 60 * 6,        // Refresh every 6 hours
  cookieCache: {
    enabled: true,               // Cache session lookups
    maxAge: 60 * 5                // 5-minute cache TTL
  }
}
```

### Cookie security

Better Auth automatically configures secure cookies:

| Property   | Value               | Purpose                                     |
| ---------- | ------------------- | ------------------------------------------- |
| `httpOnly` | `true`              | Prevents JavaScript access (XSS protection) |
| `secure`   | `true` (production) | HTTPS only in production                    |
| `sameSite` | `"lax"`             | CSRF protection                             |
| `path`     | `"/"`               | Available across all paths                  |
| `maxAge`   | 24 hours            | Session expiration                          |

## Cross-app cookie sharing

AgentC2 uses Caddy reverse proxy to enable cookie sharing between frontend and agent apps:

### Architecture

```
https://agentc2.ai              → Frontend (port 3000)
https://agentc2.ai/agent        → Agent App (port 3001)
https://agentc2.ai/api/auth     → Better Auth API (via frontend)
```

### How it works

1. **Single domain** — Both apps accessed via `agentc2.ai` domain
2. **Cookie sharing** — Better Auth cookies set on root domain with `path: "/"`
3. **Path routing** — Caddy routes `/agent*` to agent app, everything else to frontend
4. **HTTPS** — Caddy provides TLS termination with Let's Encrypt certificates
5. **Result** — Login on frontend → automatically authenticated on agent app

### Caddyfile configuration

```caddyfile
agentc2.ai {
    reverse_proxy /agent* localhost:3001
    reverse_proxy * localhost:3000
}
```

### Local development

For local development with HTTPS:

```caddyfile
catalyst.localhost {
    reverse_proxy /agent* localhost:3001
    reverse_proxy * localhost:3000
    tls internal
}
```

<Callout type="tip">
    **Local HTTPS**: Use `.localhost` domains for automatic DNS resolution to `127.0.0.1`. Caddy
    provides self-signed certificates for local HTTPS development.
</Callout>

## Role-based access control

Authentication integrates with the multi-tenant membership system:

### User → Organization mapping

```typescript
// Resolve user's organization from session
const session = await auth.api.getSession({ headers: request.headers });
const membership = await prisma.membership.findFirst({
    where: { userId: session.user.id },
    include: { organization: true }
});
```

### Membership roles

| Role       | Permissions                        | API Access         |
| ---------- | ---------------------------------- | ------------------ |
| **owner**  | Full control, billing, deletion    | All endpoints      |
| **admin**  | Manage members, workspaces, agents | Most endpoints     |
| **member** | Create/edit agents, run workflows  | Standard endpoints |
| **viewer** | Read-only access                   | GET endpoints only |

### Permission checks

```typescript
// Example: Check if user can manage agents
const membership = await getMembership(userId, organizationId);
if (membership.role !== "owner" && membership.role !== "admin") {
    throw new Error("Insufficient permissions");
}
```

## Authentication middleware

API routes use authentication middleware to validate sessions:

### Frontend middleware

```typescript
// apps/frontend/src/middleware.ts
export async function middleware(request: NextRequest) {
    const session = await auth.api.getSession({ headers: request.headers });
    if (!session && isProtectedRoute(request.nextUrl.pathname)) {
        return NextResponse.redirect(new URL("/login", request.url));
    }
}
```

### Agent app authentication

```typescript
// apps/agent/src/lib/api-auth.ts
export async function authenticateRequest(
    request?: NextRequest
): Promise<{ userId: string; organizationId: string } | null> {
    const session = await auth.api.getSession({ headers: request.headers });
    if (!session) return null;

    const membership = await prisma.membership.findFirst({
        where: { userId: session.user.id },
        include: { organization: true }
    });

    return membership
        ? { userId: session.user.id, organizationId: membership.organizationId }
        : null;
}
```

## Session lifecycle events

Better Auth provides hooks for session lifecycle:

### Post-login hook

```typescript
// Auto-create organization for new users
auth.on("after.signIn", async ({ user }) => {
    const existingMembership = await prisma.membership.findFirst({
        where: { userId: user.id }
    });

    if (!existingMembership) {
        // Create default organization and workspace
        await createDefaultOrganization(user.id);
    }
});
```

### Session refresh

Sessions are automatically refreshed every 6 hours (`updateAge`). The cookie is updated without requiring user interaction.

### Session expiration

After 24 hours (`expiresIn`), the session expires and the user must log in again. The expired session is removed from the database.

## API authentication

API endpoints accept authentication via:

### Bearer token

```bash
curl https://agentc2.ai/agent/api/agents \
  -H "Authorization: Bearer $TOKEN"
```

### Session cookie

```bash
# Cookie automatically included from browser session
curl https://agentc2.ai/agent/api/agents \
  --cookie "better-auth.session_token=..."
```

### API key (future)

For service-to-service authentication, API keys can be issued per organization:

```bash
curl https://agentc2.ai/agent/api/agents \
  -H "X-API-Key: $API_KEY" \
  -H "X-Organization-Slug: acme-corp"
```

## Social authentication

Better Auth supports OAuth providers:

### Google OAuth

```typescript
socialProviders: {
  google: {
    clientId: process.env.GOOGLE_CLIENT_ID,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    accessType: "offline",
    prompt: "consent",
    scope: ["email", "profile"],
    disableImplicitSignUp: true // Require explicit sign-up flow
  }
}
```

### Microsoft OAuth

```typescript
socialProviders: {
  microsoft: {
    clientId: process.env.MICROSOFT_CLIENT_ID,
    clientSecret: process.env.MICROSOFT_CLIENT_SECRET,
    tenantId: process.env.MICROSOFT_TENANT_ID || "common",
    scope: ["User.Read", "Mail.Read", "Calendars.ReadWrite"]
  }
}
```

## Troubleshooting

### Session not persisting

- **Check domain** — Ensure `NEXT_PUBLIC_APP_URL` matches the actual domain
- **Verify cookies** — Check browser DevTools > Application > Cookies
- **HTTPS required** — `secure: true` cookies require HTTPS in production

### Cross-app authentication fails

- **Verify Caddy routing** — Ensure `/agent*` routes to agent app
- **Check cookie domain** — Cookies must be set on root domain (`agentc2.ai`, not `app.agentc2.ai`)
- **Test cookie sharing** — Login on frontend, verify cookie visible on `/agent` requests

### Session expiration issues

- **Check `expiresIn`** — Default is 24 hours
- **Verify `updateAge`** — Sessions refresh every 6 hours
- **Monitor database** — Check `session` table for expired sessions

## Related topics

- **[Multi-Tenancy](/docs/platform/multi-tenancy)** — How sessions map to organizations
- **[Security](/docs/platform/security)** — Credential encryption and security headers
- **[Deployment](/docs/platform/deployment)** — Production authentication setup
