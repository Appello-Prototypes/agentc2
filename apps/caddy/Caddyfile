{
    # Enable local CA for self-signed certificates
    local_certs
    admin localhost:2019
}

https://catalyst.localhost {
    # Use internal self-signed certificate
    tls internal

    # Logging for development (ERROR = only show errors, no request logs)
    log {
        output stdout
        format console
        level ERROR
    }

    @voice_stream {
        path /voice/stream*
    }

    handle @voice_stream {
        reverse_proxy localhost:3002
    }

    # Public landing page â€” exact root path routes to frontend app (port 3000)
    @landing_page {
        expression `{http.request.uri.path} == "/"`
    }

    handle @landing_page {
        reverse_proxy localhost:3000
    }

    # Frontend static assets (namespaced via assetPrefix: '/_home')
    @frontend_assets {
        path /_home/*
    }

    handle @frontend_assets {
        reverse_proxy localhost:3000
    }

    # Admin portal routes to admin app (port 3003)
    @admin_routes {
        path /admin*
    }

    handle @admin_routes {
        reverse_proxy localhost:3003 {
            flush_interval -1
        }
    }

    # Embed routes -- relax framing restrictions for external iframe embedding
    @embed_routes {
        path /embed/*
    }

    handle @embed_routes {
        header X-Frame-Options ""
        header Content-Security-Policy "frame-ancestors *"
        reverse_proxy localhost:3001 {
            flush_interval -1
        }
    }

    # All other traffic routes to agent app (primary app on port 3001)
    handle {
        reverse_proxy localhost:3001 {
            # Disable buffering for SSE streams (real-time chat)
            flush_interval -1
        }
    }
}
